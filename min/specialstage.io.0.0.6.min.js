function UAS(){this.position=new THREE.Vector3,this.velocity=new THREE.Vector3,this.direction=new THREE.Vector3,this.lookAt=new THREE.Vector3,this.up=new THREE.Vector3(0,0,1);let c=[],l=0,a=!1;this.POV=0;var e=()=>({position:new THREE.Vector3,distance:new THREE.Vector3,direction:new THREE.Vector3,lookAt:new THREE.Vector3,up:new THREE.Vector3(0,0,1),lerp:1,pitch:0,roll:0,yaw:0,pov:0,target:0,targeting:!1,autopilot:!0});const h=[];var t=()=>({position:new THREE.Vector3,velocity:new THREE.Vector3,lookAt:new THREE.Vector3,up:new THREE.Vector3,pitch:{axis:new THREE.Vector3,value:0},roll:{axis:new THREE.Vector3,value:0},yaw:{axis:new THREE.Vector3,value:0},speed:0});this.AUTOPILOT=!0;let o=this.AUTOPILOT;this.TARGET=0,this.TARGETS=[],this.TARGETING=!1,this.CAM=1;let u=this.CAM;this.camera=[],this.camera[0]=e(),this.camera[0].distance=22,this.camera[0].position.set(0,0,10),this.camera[0].position.lerp=.1,this.camera[0].position.pov=!0,this.camera[1]=e(),this.camera[1].distance=22,this.camera[1].position.set(20,20,10),this.camera[1].lerp=.05,this.camera[2]=e(),this.camera[2].distance=22,this.camera[2].position.set(-20,20,20),this.camera[2].lerp=.05,this.camera[3]=e(),this.camera[3].distance=22,this.camera[3].position.set(16,-16,9),this.camera[3].pov=2,this.camera[3].lerp=.05,this.camera[4]=e(),this.camera[4].distance=0,this.camera[4].position.set(0,-20,50),this.camera[4].lerp=.075,h[0]=t(),h[1]=t(),h[2]=t(),h[3]=t(),h[4]=t(),this.reset=function(e=!1){if(e){this.CAM=0,this.TARGET=0,this.TARGETS=[];for(let e=0;e<this.camera.length;e++)this.camera[e].target=0}1<c.length?c[l].time=0:(l=0,c=[],c[0]={time:0,position:this.position.clone(),direction:this.direction.clone(),lookAt:this.lookAt.clone(),up:new THREE.Vector3,pitch:{step:0,value:0,power:9e-4,drag:.98,limit:60,axis:new THREE.Vector3(1,0,0)},roll:{step:0,value:0,power:.0015,drag:.98,limit:60,axis:new THREE.Vector3(0,1,0)},yaw:{step:0,value:0,power:.0015,drag:.98,limit:60,axis:new THREE.Vector3(0,0,1)},velocity:this.velocity.clone(),speed:0})},this.replay=function(){this.TARGET=0,this.CAM=1;for(let e=0;e<this.camera.length;e++)this.camera[e].target=0,this.camera[e].autopilot=!0},this.spectate=function(){this.TARGET=1,this.CAM=1;for(let e=0;e<this.camera.length;e++)this.camera[e].target=1,this.camera[e].autopilot=!0},this.connect=function(){this.reset()},this.disconnect=function(){this.reset(),this.TARGETS=[]},this.pov=function(e=new THREE.Vector3,t=new THREE.Vector3,i=new THREE.Vector3){var o=DNF||vehicle.END?1e-5:.1;this.up.set(0,0,1);let n=t.clone();n.multiplyScalar(-this.camera[0].distance+4*(ui.scale-1)),n.add(e),n.z+=this.camera[0].position.z,c[l].position.lerp(n,o),c[l].lookAt.copy(i),c[l].up.set(0,0,1)},this.fpv=function(e=new THREE.Vector3,t=new THREE.Vector3,i=new THREE.Vector3,o=new THREE.Vector3){c[l].position.copy(e);const n=t.clone();n.add(e),c[l].lookAt.copy(n);o=o.clone();c[l].up.copy(o)},this.orbit=function(e=new THREE.Vector3,t=new THREE.Vector3,i=new THREE.Vector3){control.SPACE,control.SHIFT,control.UP,control.DOWN,control.LEFT,control.RIGHT;let o=e.clone();o.add(this.camera[u].position),c[l].position.lerp(o,this.camera[u].lerp),c[l].lookAt.copy(i),c[l].up.set(0,0,1)},this.physics=function(e=0,t,i){if(e>c[l].time){const a=t.position.clone();var o=t.direction.clone(),n=t.lookAt.clone(),s=t.normal.clone(),i=((void 0!==i?i:a).clone(),{});for(Object.assign(i,c[l]),c=[],l=0,c.push(i);c[l].time<e;){var r={};Object.assign(r,c[l]),c.push(r),l++,vehicle.REPLAY?this.AUTOPILOT?1===this.POV?this.pov(a,o,n):2===this.POV?this.fpv(a,o,n,s):this.orbit(a,o,n):this.pilot():vehicle.FPV?this.fpv(a,o,n,s):this.pov(a,o,a),c[l].time+=TIMESTEP}}},this.target=function(e){this.lookAt.copy(this.TARGETS[e].position)},this.update=function(e=0,t=this.TARGETS){this.CAM!==u?(u=this.CAM,this.TARGET=this.camera[u].target,this.TARGETING=this.camera[u].targeting,this.AUTOPILOT=this.camera[u].autopilot,this.POV=this.camera[u].pov,o=this.AUTOPILOT,o?(c[l].position.copy(this.camera[u].position),c[l].position.add(t[this.TARGET].position),c[l].up.copy(this.camera[u].up),a=!0):(c[l].position.copy(h[u].position),c[l].lookAt.copy(h[u].lookAt),c[l].up.copy(h[u].up),c[l].velocity.copy(h[u].velocity),c[l].pitch.axis.copy(h[u].pitch.axis),c[l].roll.axis.copy(h[u].roll.axis),c[l].yaw.axis.copy(h[u].yaw.axis),c[l].pitch.value=h[u].pitch.value,c[l].roll.value=h[u].roll.value,c[l].yaw.value=h[u].yaw.value,c[l].speed=h[u].speed)):(this.camera[u].target=this.TARGET,this.camera[u].pov=this.POV,this.camera[u].targeting=this.TARGETING,this.camera[u].autopilot=this.AUTOPILOT),this.AUTOPILOT!==o&&(o=this.AUTOPILOT,this.AUTOPILOT?(c[l].position.copy(this.camera[u].position),c[l].up.copy(this.camera[u].up)):c[l].speed=0);var i=PLAY?0:this.camera[u].target;this.physics(e,t[i]);TIMESTEP,c[l].time,TIMESTEP;1<c.length&&(this.position.copy(c[l].position),this.direction.copy(c[l].direction),this.lookAt.copy(c[l].lookAt),this.velocity.copy(c[l].velocity),this.up.copy(c[l].up),camera.position.copy(this.position),camera.up.set(this.up.x,this.up.y,this.up.z),camera.lookAt(this.lookAt)),a=!1},this.pilot=function(){let e=c[l];var t=control.SPACE,i=control.SHIFT,o=control.UP,n=control.DOWN,s=control.LEFT,r=control.RIGHT;control.TARGET&&(this.TARGETING=!this.TARGETING,control.TARGET=!1,state.replay());e.pitch.value+=o?-e.pitch.power:n?+e.pitch.power:0,i&&!this.TARGETING?e.roll.value+=s?-e.roll.power:r?e.roll.power:0:(e.yaw.value+=s?e.yaw.power:r?-e.yaw.power:0,e.yaw.value*=e.yaw.drag),e.pitch.value*=e.pitch.drag,e.roll.value*=e.roll.drag,e.yaw.value*=e.yaw.drag,e.pitch.axis.applyAxisAngle(e.roll.axis,e.roll.value),e.pitch.axis.applyAxisAngle(e.yaw.axis,e.yaw.value),e.roll.axis.applyAxisAngle(e.pitch.axis,e.pitch.value),e.roll.axis.applyAxisAngle(e.yaw.axis,e.yaw.value),e.yaw.axis.applyAxisAngle(e.pitch.axis,e.pitch.value),e.yaw.axis.applyAxisAngle(e.roll.axis,e.roll.value),i&&t&&-1<e.speed?e.speed-=.005:t&&e.speed<1&&(e.speed+=.005),e.velocity.copy(e.roll.axis),e.velocity.multiplyScalar(e.speed),e.position.add(e.velocity),this.TARGETING?(s&&0<this.TARGET&&(--this.TARGET,state.replay(),control.LEFT=!1),r&&this.TARGET<this.TARGETS.length-1&&(this.TARGET+=1,state.replay(),control.RIGHT=!1),this.up.set(0,0,1),a?e.lookAt.lerp(this.TARGETS[this.TARGET].position,.1):e.lookAt.copy(this.TARGETS[this.TARGET].position)):(e.up.copy(e.yaw.axis),e.lookAt.copy(e.roll.axis),e.lookAt.add(e.position)),h[u].position.copy(e.position),h[u].lookAt.copy(e.lookAt),h[u].velocity.copy(e.velocity),h[u].up.copy(e.up),h[u].pitch.axis.copy(e.pitch.axis),h[u].roll.axis.copy(e.roll.axis),h[u].yaw.axis.copy(e.yaw.axis),h[u].pitch.value=e.pitch.value,h[u].roll.value=e.roll.value,h[u].yaw.value=e.yaw.value,h[u].speed=e.speed},this.debug=function(){console.log("Vehicle Timestamp:",vehicle.TIMESTAMP),console.log("Physics:",c),console.log("lookAt:",this.lookAt)}}function Control(){var i=this;this.MOBILE=!1,this.UP=!1,this.DOWN=!1,this.BACK=!1,this.FORWARD=!1,this.LEFT=!1,this.RIGHT=!1,this.ENTER=!1,this.SPACE=!1,this.SHIFT=!1,this.CTRL=!1,this.ESC=!1,this.HIDE=!1,this.BACK=!1,this.TRACK=!1,this.GAMEPAD=!1,this.BINDINGS=!1,this.touches=[];let o="";this.connect=function(){this.MOBILE?(window.addEventListener("touchstart",i.touch,!1),window.addEventListener("touchmove",i.touch,!1),window.addEventListener("touchend",i.touch,!1)):(window.addEventListener("keydown",i.key,!1),window.addEventListener("keyup",i.key,!1),window.addEventListener("mousedown",i.mousedown),window.addEventListener("mouseup",i.mouseup,!1),window.addEventListener("touchstart",i.touchSetup,!1))},this.disconnect=function(){window.removeEventListener("keydown",i.key,!1),window.removeEventListener("keyup",i.key,!1),window.removeEventListener("mousedown",i.mousedown,!1),window.removeEventListener("mouseup",i.mouseup,!1),window.removeEventListener("touchstart",i.touchSetup,!1),window.removeEventListener("touchstart",i.touch,!1),window.removeE,ventListener("touchmove",i.touch,!1),window.removeEventListener("touchend",i.touch,!1)},this.key=function(e){var t="keydown"==e.type;switch(t||(o+=e.key),3<o.length&&(o=o.slice(1,4)),e.key){case"ArrowUp":i.UP=t;break;case"ArrowDown":i.DOWN=t;break;case"ArrowLeft":i.LEFT=t;break;case"ArrowRight":i.RIGHT=t;break;case"w":i.UP=t;break;case"s":i.DOWN=t;break;case"a":i.LEFT=t;break;case"d":i.RIGHT=t;break;case"r":i.RESET=t;break;case" ":i.SPACE=t;break;case"Shift":i.SHIFT=t;break;case"Enter":i.ENTER=t;break;case"Control":i.CTRL=t;break;case"Escape":case"Backspace":i.ESC=t;break;case"=":i.ZOOM_IN=t;break;case"-":i.ZOOM_OUT=t;break;case"t":i.TARGET=t;break;case"h":i.HIDE=t;break;case">":!t&&PIXEL_SCALE<2&&(PIXEL_SCALE+=.5),resize();break;case"<":!t&&.5<PIXEL_SCALE&&(PIXEL_SCALE-=.5),resize()}UAS_ENABLED?!vhs.PLAY||MENU||UAS_IS_ACTIVE||"vhs"===o&&(ui.print("code detected: ghost data overwrite","2","2"),window.setTimeout(vhs.export,1e3,state.results,!1),o=""):"uas"===o&&(UAS_ENABLED=!0,MENU=!0,state.settings(state.STATE),ui.print("code detected: uas enabled","2","2"),o="")},this.mousedown=function(e){e.preventDefault(),i.touches[0]={x:e.clientX,y:e.clientY,start:!0}},this.mouseup=function(e){e.preventDefault(),i.touches[0]={x:e.clientX,y:e.clientY,start:!1}},this.touchSetup=function(e){window.removeEventListener("keydown",i.key,!1),window.removeEventListener("keyup",i.key,!1),window.removeEventListener("keyup",i.key,!1),window.removeEventListener("mousedown",i.mousedown,!1),window.removeEventListener("mouseup",i.mouseup,!1),window.removeEventListener("touchstart",i.touchSetup,!1),window.addEventListener("touchstart",i.touchstart,!1),window.addEventListener("touchmove",i.touchmove,!1),window.addEventListener("touchend",i.touchend,!1),i.touchstart(e)},this.clear=function(){i.touches=[],this.UP=!1,this.DOWN=!1,this.LEFT=!1,this.RIGHT=!1,this.ENTER=!1},this.touchstart=function(e){var t=e.touches;i.touches=[];for(let e=0;e<t.length;e++)i.touches[e]={x:t[e].clientX,y:t[e].clientY,start:!0}},this.touchmove=function(e){i.touches=[];var t=e.touches;for(let e=0;e<t.length;e++)i.touches[e]={x:t[e].clientX,y:t[e].clientY,start:!1}},this.touchend=function(e){i.touches=[];var t=e.touches;for(let e=0;e<t.length;e++)i.touches[e]={x:t[e].clientX,y:t[e].clientY,start:!1}}}function Generate(){(scope=this).SEED=0;let m=0;this.length=480;const l=[];let d=0;l[0]={name:"forest",palette:palette[9],tree:function(e,t){return scope.pine()},limit:Math.floor(scope.length/2),range:5,map:[],flags:[]},l[0].map[0]=function(e,t){let i=palette[10],o=!1;return.92<Math.abs(e)&&(i=.92<Math.abs(e)?palette[9]:palette[2],o=!0),l[0].flags[t]=o,i},l[1]={name:"sakura",palette:palette[12],tree:function(){return scope.sakura()},limit:Math.floor(scope.length*(1/6)),range:10,map:[],flags:[]},l[1].map[0]=function(e,t){let i=palette[1],o=!1;return.95<Math.abs(e)&&(i=.92<Math.abs(e)?palette[12]:palette[1],o=!0),l[1].flags[t]=o,i},l[2]={name:"summit",palette:palette[1],tree:function(){return new THREE.Geometry},limit:0,range:10,map:[],flags:[]},l[2].map[0]=function(e,t){let i=palette[7],o=!1;return.95<Math.abs(e)&&(i=.92<Math.abs(e)?palette[2]:palette[7],o=!0),l[2].flags[t]=o,i};const g=new THREE.Points(new THREE.Geometry);g.name="Generative Extruder",g.visible=!1;const y=new THREE.Line(new THREE.Geometry);y.name="Generative Nodes",y.visible=!1,y.material.color=palette[6],y.material.name="Node Material",y.position.z+=2;const f=new THREE.LineSegments(new THREE.Geometry);f.name="Generative Segments",f.visible=!0,f.material.color=palette[3],f.material.name="Segments Material";const n=new THREE.Mesh(new THREE.Geometry);n.name="Generative Surface",n.visible=!1,n.material.color=palette[0],n.material.name="Surface Material";const r=new THREE.LineSegments(new THREE.Geometry);r.name="Generative Perimeter",r.material.color=palette[1],r.material.name="Perimeter Material";const A=new THREE.Mesh(new THREE.Geometry,new THREE.MeshBasicMaterial({vertexColors:THREE.VertexColors}));A.name="Terrain",A.material.name="Terrain Material",A.material.wireframe=!0,A.material.side=THREE.DoubleSide,A.visible=!0,wireframe=new THREE.Mesh(new THREE.Geometry,new THREE.MeshBasicMaterial({vertexColors:THREE.VertexColors})),wireframe.name="Wireframe",wireframe.material.name="Wireframe Material",wireframe.material.wireframe=!0,wireframe.material.side=THREE.FrontSide,wireframe.visible=!0;const h=new THREE.LineSegments(new THREE.Geometry,new THREE.LineBasicMaterial({vertexColors:THREE.VertexColors}));h.name="Trees";const o=new THREE.Mesh(new THREE.Geometry,new THREE.MeshBasicMaterial);o.name="Background",o.material.color=palette[0],o.material.name="Background Material",o.material.wireframe=!1,o.material.side=THREE.FrontSide,o.material.opacity=.75,o.material.blendMode=THREE.MultiplyBlending,o.material.transparent=!0;const a=new THREE.Points(new THREE.Geometry);a.material.color=palette[1],a.material.sizeAttenuation=!1,a.material.size=1.5,a.material.fog=!1,scope.stars=a;const w=new THREE.Mesh(new THREE.Geometry,new THREE.MeshBasicMaterial);w.name="Collision Mesh",w.visible=!0,w.material.name="Collision Material",w.material.side=THREE.BackSide,this.checkpoints=[];const R=new THREE.Vector3(0,0,1);var I=new THREE.Vector3(1,0,0);new THREE.Vector3(0,1,0),new THREE.Vector3(0,0,1);const S=new THREE.Vector3(0,3,0),e=new THREE.Vector3(0,0,1),M=y.geometry.clone(),N=n.geometry.clone(),O=f.geometry.clone(),H=r.geometry.clone(),c=[],u=[],L=new THREE.Vector3;c[0]=new THREE.Vector3(5,3,0),c[1]=new THREE.Vector3(-5,3,0),u[0]=c[0].clone(),u.z+=1,u[1]=c[1].clone(),u.z+=1;var b=Math.PI/64,P=Math.PI/32;let C=[];let p=0,_=new THREE.Vector3;this.start=new THREE.Vector3;let E=!1,D=!1;let T=!1;this.END=!1,this.IMPORT=!1,this.DISTANCE=0;let B=18;const G=new THREE.Raycaster;G.far=800,g.geometry.vertices[0]=S.clone(),g.geometry.vertices[1]=R.clone().add(S),g.geometry.vertices[2]=c[0].clone(),g.geometry.vertices[3]=c[1].clone(),g.geometry.vertices[4]=u[0].clone(),g.geometry.vertices[5]=u[1].clone(),this.connect=function(){scope.SEED=SEED,d=scope.randomInt(0,3),stage.SNOW=2===d,stage.SNOW&&stage.snow.init(),scene.add(g),scene.add(y),scene.add(f),scene.add(r),scene.add(n),scene.add(wireframe),scene.add(o),p=window.performance.now(),window.setTimeout(scope.generate,0)},this.disconnect=function(){for(var e in C=[],scene.remove(g),scene.remove(y),scene.remove(f),scene.remove(r),scene.remove(n),scene.remove(wireframe),scene.remove(o),scene.remove(h),l)l[e].flag=[];for(var t in scope.checkpoints)scene.remove(scope.checkpoints[t].display),scope.checkpoints[t].display.geometry.dispose(),scope.checkpoints[t].collision.geometry.dispose()},this.complete=function(){w.geometry.mergeVertices(),w.geometry.verticesNeedUpdate=!0,w.geometry.elementsNeedUpdate=!0,w.geometry.computeFaceNormals(),w.geometry.computeVertexNormals(),w.geometry.computeBoundingSphere(),o.geometry.copy(w.geometry),--o.position.z;let t=[];for(let e=0;e<w.geometry.faces.length;e++)t[w.geometry.faces[e].a]=w.geometry.faces[e].vertexNormals[0].clone(),t[w.geometry.faces[e].b]=w.geometry.faces[e].vertexNormals[1].clone(),t[w.geometry.faces[e].c]=w.geometry.faces[e].vertexNormals[2].clone();for(let e=0;e<w.geometry.vertices.length;e++)w.geometry.vertices[e].add(t[e].multiplyScalar(2));w.geometry.verticesNeedUpdate=!0,w.geometry.computeFaceNormals(),w.geometry.computeVertexNormals(),w.geometry.computeBoundingSphere(),wireframe.geometry.mergeVertices(),wireframe.geometry.verticesNeedUpdate=!0,wireframe.geometry.elementsNeedUpdate=!0,wireframe.geometry.computeFaceNormals(),wireframe.geometry.computeBoundingSphere();const e=new THREE.IcosahedronGeometry(1200,10);for(var i in e.vertices)scope.random()<.3&&-400<e.vertices[i].z&&a.geometry.vertices.push(e.vertices[i].clone());e.dispose(),a.geometry.computeBoundingSphere(),stage.surface=w.clone(),stage.start=scope.start.clone(),p=window.performance.now()-p,E=!0,scope.END=!0,FIREBASE&&firebase.analytics().logEvent("stage_generation_complete",{time:Math.round(p/1e3)}),BATTLE?(ui.clear(),vehicle.connect(stage.start,stage.surface),vehicle.PLAY=!1,vhs.PLAY=!0):state.ready()},this.reset=function(){B=(36+scope.random()-.5)/2,m=0,y.geometry.dispose(),f.geometry.dispose(),n.geometry.dispose(),g.geometry.dispose(),r.geometry.dispose(),A.geometry.dispose(),wireframe.geometry.dispose(),w.geometry.dispose(),h.geometry.dispose(),a.geometry.dispose(),O.dispose(),H.dispose(),M.dispose(),N.dispose(),O.copy(new THREE.Geometry),H.copy(new THREE.Geometry),M.copy(new THREE.Geometry),N.copy(new THREE.Geometry),y.geometry.copy(new THREE.Geometry),g.geometry.copy(new THREE.Geometry),f.geometry.copy(new THREE.Geometry),r.geometry.copy(new THREE.Geometry),n.geometry.copy(new THREE.Geometry),A.geometry.copy(new THREE.Geometry),w.geometry.copy(new THREE.Geometry),S.set(0,3,0),e.set(0,0,1),c[0]=new THREE.Vector3(4,3,0),c[1]=new THREE.Vector3(-4,3,0),E&&(E=!1,D=!1,T=!1),this.END=!1,g.position.set(0,0,0),g.geometry.vertices[0]=S.clone(),g.geometry.vertices[1]=R.clone().add(S),g.geometry.vertices[2]=c[0].clone(),g.geometry.vertices[3]=c[1].clone(),g.geometry.vertices[4]=u[0].clone(),g.geometry.vertices[5]=u[1].clone(),g.geometry.verticesNeedUpdate=!0},this.generate=function(){scope.path()},this.path=function(t=0,i=0,e=0,o=0,n=0,s={start:0,end:30,angle:0,slope:0},r=[],a=[],c=!1,l=999){var h=window.performance.now();let u=0;for(0===o&&(o=.5<scope.random()?1:-1);u<32&&!D;){if(t===s.end+1){a=[];for(let e=0;e<1;e++)if(t>=scope.length)a.push({angle:0,slope:0,end:30}),l=t+30;else if(0===i){var p=scope.randomInt(2,4)*o,E=Math.floor(Math.abs(36/p));o=scope.random()<.01?+o:-1*o;E=scope.randomInt(1,E);a.push({angle:p,slope:0,end:E})}else{let e=scope.randomInt(-5,-1);E=scope.random();e=2!==d&&E<.05?e*=-1:e;E=scope.randomInt(2,20);a.push({angle:0,slope:e,end:E})}var T=scope.randomInt(0,a.length);i=a[T].angle,e=a[T].slope,s.start=t,s.end=t+a[T].end,a=a.slice(T,1)}if(c||(scope.extrude(i,e),C.push({angle:i,slope:e}),M.verticesNeedUpdate=!0,t++),10<=t&&!c){var m=new THREE.Vector2(M.vertices[t-1].x,M.vertices[t-1].y);for(let t=0;t<M.vertices.length-1-10;t++){let e=new THREE.Vector2(M.vertices[t].x,M.vertices[t].y);if(e.distanceTo(m)<18){c=!0;break}}c&&window.setTimeout(stage.reset(!0),0)}0,t===l&&(D=!0,y.geometry.dispose(),y.geometry=M.clone(),y.geometry.computeBoundingSphere(),y.geometry.center(),y.updateMatrixWorld(),0<y.geometry.vertices.length&&(_.copy(y.geometry.vertices[0]),_.sub(M.vertices[0])),window.setTimeout(function(){state.PATH=!0,state.STATE(),scope.import()},0)),u=window.performance.now()-h}D||c||window.setTimeout(scope.path,0,t,i,e,o,n,s,r,a,c,l)},this.skijump=function(e=0,t=0,i=0,o=0,n=0,s={start:0,end:20,angle:0,slope:0},r=[],a=[],c=!1,l=300,h=0){var u=window.performance.now();let p=0;for(0===o&&(o=.5<scope.random()?1:-1);p<32&&!D;){if(e===s.end+1){a=[];for(let e=0;e<1;e++)0===i&&20===s.end?(h=-1,a.push({angle:0,slope:-4,end:30})):3===i?a.push({angle:0,slope:4,end:3}):4===i?a.push({angle:0,slope:-32,end:10}):-4===i?(h=1,a.push({angle:0,slope:i+1,end:1})):-32===i?a.push({angle:0,slope:-4,end:40}):1==h?a.push({angle:0,slope:i+1,end:1}):-1==h&&a.push({angle:0,slope:i-1,end:1});var E=scope.randomInt(0,a.length);t=a[E].angle,i=a[E].slope,s.start=e,s.end=e+a[E].end,a=a.slice(E,1)}if(c||(scope.extrude(t,i),C.push({angle:t,slope:i}),M.verticesNeedUpdate=!0,e++),10<=e&&!c){var T=new THREE.Vector2(M.vertices[e-1].x,M.vertices[e-1].y);for(let t=0;t<M.vertices.length-1-10;t++){let e=new THREE.Vector2(M.vertices[t].x,M.vertices[t].y);if(e.distanceTo(T)<0){c=!0;break}}c&&window.setTimeout(stage.reset(!0),0)}0,l<=e&&(D=!0,y.geometry.dispose(),y.geometry=M.clone(),y.geometry.computeBoundingSphere(),y.geometry.center(),y.updateMatrixWorld(),0<y.geometry.vertices.length&&(_.copy(y.geometry.vertices[0]),_.sub(M.vertices[0])),window.setTimeout(function(){scope.import()},0)),p=window.performance.now()-u}D||c||window.setTimeout(scope.skijump,0,e,t,i,o,n,s,r,a,c,l)},this.import=function(e=0){var t=window.performance.now();let i=0;for(;!T&&i<32;){if(0===e&&(g.position.set(0,0,0),g.rotation.z=0,S.set(0,3,0),g.geometry.vertices[0]=S.clone(),g.geometry.vertices[1]=R.clone().add(S),g.geometry.vertices[2]=c[0].clone(),g.geometry.vertices[3]=c[1].clone(),g.geometry.vertices[4]=u[0].clone(),g.geometry.vertices[5]=u[1].clone(),g.geometry.verticesNeedUpdate=!0,g.updateMatrixWorld()),e<C.length)m=e,angle=C[e].angle,slope=C[e].slope,scope.extrude(angle,slope),f.geometry.dispose(),f.geometry=O.clone(),f.geometry.computeBoundingSphere(),r.geometry.dispose(),r.geometry=H.clone(),r.geometry.computeBoundingSphere(),n.geometry.dispose(),n.geometry=N.clone(),n.geometry.computeBoundingSphere(),e++;else if(!T&&e===C.length){for(var o in scope.checkpoints=scope.checkpoint(),scope.checkpoints)scene.add(scope.checkpoints[o].display);T=!0,window.setTimeout(function(){scope.terrain(!0)},0)}i=window.performance.now()-t}T||window.setTimeout(scope.import,0,e,angle,slope)},this.extrude=function(e=0,t=0){for(var i in g.updateMatrixWorld(),g.rotateZ(e*P),g.geometry.vertices)g.geometry.vertices[i].applyAxisAngle(I,t*b);g.geometry.verticesNeedUpdate=!0;const o=g.geometry.vertices[0].clone(),n=g.geometry.vertices[2].clone(),s=g.geometry.vertices[3].clone(),r=g.geometry.vertices[1].clone();if(o.applyMatrix4(g.matrix),n.applyMatrix4(g.matrix),s.applyMatrix4(g.matrix),r.applyMatrix4(g.matrix),r.sub(o),D){if(n.add(_),s.add(_),0<O.vertices.length){var a=O.vertices[O.vertices.length-1].clone().sub(L),c=O.vertices[O.vertices.length-2].clone().sub(L);N.vertices.push(n.clone().sub(r)),N.vertices.push(s.clone().sub(r)),N.vertices.push(c),N.vertices.push(s.clone().sub(r)),N.vertices.push(a),N.vertices.push(c);var l=n.clone(),e=s.clone(),a=O.vertices[O.vertices.length-1].clone(),c=O.vertices[O.vertices.length-2].clone();w.geometry.vertices.push(l),w.geometry.vertices.push(e),w.geometry.vertices.push(c),w.geometry.vertices.push(e),w.geometry.vertices.push(a),w.geometry.vertices.push(c);a=N.vertices.length;const u=new THREE.Face3(a-3,a-2,a-1),p=new THREE.Face3(a-5,a-4,a-6);N.faces.push(u),N.faces.push(p);const E=u.clone(),T=p.clone();E.color=new THREE.Color(16777215),T.color=new THREE.Color(16777215),w.geometry.faces.push(E),w.geometry.faces.push(T)}if(0<H.vertices.length){let e=2,t=1;4<H.vertices.length&&(e=4,t=2);let i=H.vertices[H.vertices.length-e].clone(),o=H.vertices[H.vertices.length-t].clone();H.vertices.push(n.clone().add(r)),H.vertices.push(i.clone()),H.vertices.push(s.clone().add(r)),H.vertices.push(o.clone()),m==C.length-1&&(c=n.clone().add(r),a=s.clone().add(r),H.vertices.push(c),H.vertices.push(a))}else H.vertices.push(n.clone().add(r)),H.vertices.push(s.clone().add(r));O.vertices.push(n.clone()),O.vertices.push(s.clone()),L.copy(r)}else M.vertices.push(o.clone());for(var h in S.copy(o).sub(g.position),g.position.add(S),g.geometry.vertices)g.geometry.vertices[h].applyAxisAngle(I,-1*t*b)},this.terrain=function(e=!0,o=[],n=[],r=[],t=0,a=0,c=0){if(e){f.updateMatrixWorld(),A.geometry.dispose(),A.geometry.copy(new THREE.Geometry),o=[],n=[],r=[];for(let e=0;e<2;e++)r[e]=[],o[e]=[],n[e]=[];for(let e=0;e<f.geometry.vertices.length;e++){var i=e%2;n[i].push(f.geometry.vertices[e])}for(let i=0;i<2;i++)for(let t=0;t<n[i].length;t++){var l=0===i?1:-1;let e=n[i][t].clone();e.sub(n[i+l][t]),e.normalize().multiplyScalar(3),r[i][t]=e.clone()}}let h=0;var u,p=window.performance.now();if(t<4){if(A.geometry.verticesNeedUpdate=!0,A.geometry.elementsNeedUpdate=!0,A.geometry.computeBoundingSphere(),A.geometry.computeFaceNormals(),A.geometry.computeVertexNormals(),A.updateMatrixWorld(),0<t&&0===c){n[a]=[];for(let e=0;e<o[a].length;e++)n[a][e]=A.geometry.vertices[o[a][e]]}for(0===c&&(o[a]=[]),v=c;v<n[a].length&&h<32;){let i=!1;if(void 0!==n[a][v]&&void 0!==n[a][v-1]){if(void 0===r[a][v])r[a][v]=r[s][v-1].clone();else{A.geometry.computeBoundingSphere();let e=n[a][v].clone().add(r[a][v]);e.z-=100,G.set(e,R),e.z+=100;let t=G.intersectObjects([A],!0);if(0<t.length)for(var E in t).01<t[E].point.distanceTo(e)&&(o[a][v]=void 0,i=!0)}i||(A.geometry.vertices.push(n[a][v].clone()),A.geometry.vertices.push(n[a][v].clone().add(r[a][v])),o[a][v]=A.geometry.vertices.length-1,0<v&&(A.geometry.vertices.push(n[a][v-1].clone()),u=A.geometry.vertices.length,0===a?A.geometry.faces.push(new THREE.Face3(u-2,u-1,u-3)):1===a&&A.geometry.faces.push(new THREE.Face3(u-1,u-2,u-3))))}h=window.performance.now()-p,v++,c=v}if(c===n[a].length){c=0;for(let t=1;t<o[a].length;t++)if(void 0!==o[a][t]&&void 0!==o[a][t-1]){let e=A.geometry.vertices[o[a][t]];var T,m=A.geometry.vertices[o[a][t-1]];e.distanceTo(m)<2.8?(e.copy(m),o[a][t]=o[a][t-1],r[a][t].copy(r[a][t-1])):1<t&&(A.geometry.vertices.push(n[a][t-1]),T=0===a?o[a][t]:o[a][t-1],m=0===a?o[a][t-1]:o[a][t],A.geometry.faces.push(new THREE.Face3(T,m,A.geometry.vertices.length-1)))}a++}1<a&&(a=0,t++)}if(4===t){A.geometry.verticesNeedUpdate=!0,A.geometry.elementsNeedUpdate=!0,A.geometry.colorsNeedUpdate=!0,A.geometry.computeFaceNormals(),A.geometry.computeVertexNormals(),A.geometry.mergeVertices(),A.geometry.computeBoundingSphere(),scope.noise(A.geometry);for(let t=0;t<A.geometry.faces.length;t++){var d=A.geometry.vertices[A.geometry.faces[t].a].clone(),g=A.geometry.vertices[A.geometry.faces[t].b].clone(),y=A.geometry.vertices[A.geometry.faces[t].c].clone();A.geometry.colors[A.geometry.faces[t].a],A.geometry.colors[A.geometry.faces[t].b],A.geometry.colors[A.geometry.faces[t].c];w.geometry.vertices.push(d),w.geometry.vertices.push(g),w.geometry.vertices.push(y),wireframe.geometry.vertices.push(d),wireframe.geometry.vertices.push(g),wireframe.geometry.vertices.push(y);y=w.geometry.vertices.length;let e=new THREE.Face3(y-1,y-2,y-3);e.color=new THREE.Color(0),w.geometry.faces.push(e),wireframe.geometry.faces.push(new THREE.Face3(y-1,y-2,y-3))}wireframe.geometry.copy(A.geometry),wireframe.geometry.computeVertexNormals(),scope.biome(),window.setTimeout(scope.complete,0)}else window.setTimeout(function(){scope.terrain(!1,o.slice(),n.slice(),r.slice(),t,a,c)},0)},this.biome=function(){var i=d;const o=wireframe.geometry.faces;let n=[],s=[];for(let t=0;t<o.length;t++)for(let e=0;e<l[d].map.length;e++)o[t].vertexColors[0]=l[d].map[e](o[t].vertexNormals[0].z,o[t].a),o[t].vertexColors[1]=l[d].map[e](o[t].vertexNormals[1].z,o[t].b),o[t].vertexColors[2]=l[d].map[e](o[t].vertexNormals[2].z,o[t].c);for(let t=0;t<l[d].flags.length;t++)for(let e=0;e<f.geometry.vertices.length;e++)wireframe.geometry.vertices[t].distanceTo(f.geometry.vertices[e])<.1&&(l[d].flags[t]=!1);for(let e=0;e<l[d].flags.length;e++)l[d].flags[e]&&n.push(e);let r=0;for(;r<l[d].limit&&r<n.length;){let t=scope.randomInt(0,n.length),e=!0;if(0<s.length&&0<n.length)for(;e;){for(var a in s){if(wireframe.geometry.vertices[n[t]].distanceTo(wireframe.geometry.vertices[s[a]])<l[d].range){e=!0,n.slice(t,1),t=scope.randomInt(0,n.length);break}e=!1}n.length<=0&&(e=!1)}if(0<n.length){let e=l[i].tree();for(var c in e.vertices)h.geometry.vertices.push(e.vertices[c].clone().add(wireframe.geometry.vertices[n[t]])),h.geometry.colors[h.geometry.vertices.length-1]=e.colors[c];s.push(n[t]),n.slice(t,1)}r++}h.verticesNeedUpdate=!0,h.elementsNeedUpdate=!0,scene.add(h)},this.sakura=function(){let c=new THREE.Geometry,l=[],h=[];let u=1;var s,e=new THREE.Vector3(0,0,0);let t=new THREE.Vector3(0,0,3),p=12,i=0,o=new THREE.Vector3(1,0,0),n=new THREE.Vector3(0,0,1);c.vertices.push(e),c.vertices.push(t),c.colors.push(palette[2]),c.colors.push(palette[2]),h.push({v:t.clone(),n:t.clone(),pitch:o.clone(),roll:n.clone()});let E=[];for(;i<4;){let a=[];for(let r=0;r<h.length;r++){let s=0;for(let n=0;n<3;n++){var T=0===i&&2===n&&s<1?1:scope.random();if(.2<T){T=scope.randomInt(-2,2);let e=h[r].n.clone();var m=palette[2];e.applyAxisAngle(h[r].pitch,2*Math.PI/(p+T)),e.applyAxisAngle(h[r].roll,2*Math.PI/3*n),e.multiplyScalar(u);let t=e.clone().add(h[r].v);c.vertices.push(h[r].v.clone()),c.vertices.push(t),c.colors.push(m),c.colors.push(m);let i=h[r].pitch.clone();i.applyAxisAngle(h[r].roll,2*Math.PI/3*n),i.applyAxisAngle(h[r].pitch,2*Math.PI/p);let o=h[r].roll.clone();o.applyAxisAngle(h[r].pitch,2*Math.PI/p),o.applyAxisAngle(h[r].roll,2*Math.PI/3*n),0<n&&l.push({a:t.clone(),b:h[r].v.clone(),pitch:i,roll:o}),a.push({v:t.clone(),n:e.clone(),pitch:i,roll:o}),s++}else 0===s&&2===n&&E.push({v:h[r].v.clone(),n:h[r].n.clone(),pitch:h[r].pitch.clone(),roll:h[r].roll.clone()})}}h=a.slice(),u*=.9,i++}for(s in p=6,l){let e=l[s].a.clone();var r=l[s].b.clone();let t=e.clone().sub(r);var a=t.clone().multiplyScalar(.5).add(r),d=scope.randomInt(0,3)-1;t.applyAxisAngle(l[s].pitch,2*Math.PI/p),t.applyAxisAngle(l[s].roll,2*Math.PI/d),t.multiplyScalar(.5);r=a;let i=t.clone().add(a);c.vertices.push(r),c.vertices.push(i),c.colors.push(palette[2]),c.colors.push(palette[2]);let o=l[s].pitch.clone();o.applyAxisAngle(l[s].roll,2*Math.PI/d),o.applyAxisAngle(l[s].pitch,2*Math.PI/p);let n=l[s].roll.clone();n.applyAxisAngle(l[s].pitch,2*Math.PI/p),n.applyAxisAngle(l[s].roll,2*Math.PI/d),h.push({v:i.clone(),n:t.clone(),pitch:o,roll:n})}h=h.concat(E);for(let i=0;i<h.length;i++)for(let t=0;t<5;t++){let e=h[i].n.clone();e.normalize(),e.applyAxisAngle(h[i].pitch,2*Math.PI/6),e.applyAxisAngle(h[i].roll,2*Math.PI/5*t),e.multiplyScalar(.5);var g=e.add(h[i].v),y=h[i].v.clone();c.vertices.push(g),c.vertices.push(y),c.colors.push(palette[12]),c.colors.push(palette[12])}return c.colorsNeedUpdate=!0,c},this.pine=function(){var i=Math.floor(8*scope.random())+6,o=2*Math.PI/6;const n=new THREE.Geometry;n.vertices.push(new THREE.Vector3(0,0,0)),n.vertices.push(new THREE.Vector3(0,0,+i-.5+1)),n.colors.push(palette[9]),n.colors.push(palette[9]),n.colors.push(palette[9]);for(let t=1;t<i;t++)for(let e=0;e<6;e++)off=o*(t%2*.5),n.vertices.push(new THREE.Vector3(0,0,+t+1)),n.vertices.push(new THREE.Vector3(.3*(i-t),0,+t-.3+1)),n.vertices[n.vertices.length-1].applyAxisAngle(R,o*e+off),n.colors.push(palette[9]),n.colors.push(palette[9]);return n},this.checkpoint=function(){var e=f.geometry,t=e.vertices.length-80,i=Math.floor(t/4)-Math.floor(t/4)%2;const o=[];o[0]=n(e.vertices[40],e.vertices[41],0),o[1]=n(e.vertices[40+i],e.vertices[1+i+40],1),o[2]=n(e.vertices[2*i+40],e.vertices[2*i+1+40],2),o[3]=n(e.vertices[3*i+40],e.vertices[3*i+1+40],3),o[4]=n(e.vertices[4*i+40],e.vertices[4*i+1+40],4),this.DISTANCE=4*i/2*3,scope.start.copy(e.vertices[36]),scope.start.sub(e.vertices[37]),scope.start.multiplyScalar(-.75),scope.start.add(e.vertices[36]);for(let e=0;e<5;e++)null==stage.best&&(stage.best[e]=e<4?i*(e+1)/B:stage.best[e]=stage.best[e-1]);function n(e,t,i){const o=new THREE.Geometry,n=(new THREE.Vector3).copy(e).sub(t);var s=(new THREE.Vector3).copy(e).add(n.clone().multiplyScalar(1.5)),r=(new THREE.Vector3).copy(t).sub(n.clone().multiplyScalar(1.5));o.vertices.push(new THREE.Vector3(s.x,s.y,s.z-12)),o.vertices.push(new THREE.Vector3(s.x,s.y,s.z+12)),o.vertices.push(new THREE.Vector3(r.x,r.y,r.z+12)),o.vertices.push(new THREE.Vector3(r.x,r.y,r.z+12)),o.vertices.push(new THREE.Vector3(r.x,r.y,r.z-12)),o.vertices.push(new THREE.Vector3(s.x,s.y,s.z-12)),o.faces.push(new THREE.Face3(0,1,2)),o.faces.push(new THREE.Face3(3,4,5));const a=new THREE.Geometry;a.vertices.push(new THREE.Vector3(e.x,e.y,e.z+6)),a.vertices.push(new THREE.Vector3(e.x,e.y,e.z+8)),a.vertices.push(new THREE.Vector3(t.x,t.y,t.z+6)),a.vertices.push(new THREE.Vector3(t.x,t.y,t.z+8)),a.vertices.push(new THREE.Vector3(e.x,e.y,e.z+6)),a.vertices.push(new THREE.Vector3(t.x,t.y,t.z+6)),a.vertices.push(new THREE.Vector3(e.x,e.y,e.z+8)),a.vertices.push(new THREE.Vector3(t.x,t.y,t.z+8)),a.vertices.push(new THREE.Vector3(e.x,e.y,e.z+1)),a.vertices.push(new THREE.Vector3(t.x,t.y,t.z+1));const c=new THREE.MeshBasicMaterial({side:THREE.DoubleSide,wireframe:!1,fog:!0});c.color=palette[5];const l=new THREE.Mesh(o,c);l.visible=!0;const h=new THREE.LineSegments(a,c);return l.name="Objective "+i,h.name="Checkpoint"+i,{display:h,collision:l}}return state.STATE(),o},this.resetCheckpoints=function(){for(var e in scope.checkpoints)scope.checkpoints[e].display.material.color=palette[5]},this.random=function(){SEED=(SEED+1)%2147483647;var e=1e4*Math.sin(SEED);return e-=Math.floor(e)},this.randomInt=function(e,t){return Math.floor(scope.random()*(t-e))+e},this.noise=function(o){const t=new ImprovedNoise,n=[];let i=8,s=0,r=0;var a=1e3*scope.random();d;for(let e=0;e<o.vertices.length;e++)n[e]=0;for(let e=0;e<2;e++){for(let e=0;e<o.vertices.length;e++){var c=o.vertices[e].x,l=o.vertices[e].y;n[e]+=Math.floor(t.noise(c/i,l/i,a)*i),n[e]>s&&(s=n[e]),n[e]<r&&(r=n[e])}i*=3}for(let i=0;i<n.length;i++){let t=2===d?2:.5;for(let e=0;e<f.geometry.vertices.length;e++){var h=o.vertices[i].distanceTo(f.geometry.vertices[e]),h=h*h/100;h<t&&(t=h)}o.vertices[i].z+=n[i]*t}},this.name=function(){let t="";if(CUSTOM_SEED)t=state.custom_seed;else if(CHALLENGE||BATTLE)t=state.CHALLENGES.seed;else{var i=[" forest"," pass"," mountain"],o=["wa","tsu","mi","n","wa","ra","ya","ma","ha","na","ta","ka","a","wi","ri","mi","hi","ni","chi","shi","ki","i","ru","yu","mu","fu","nu","tsu","su","ku","u","we","re","me","he","ne","te","se","ke","e","wo","ro","yo","mo","no","to","so","ko","o"];TOGGLE=!1;var n=Math.ceil(3*Math.random())+1;let e=0;for(;e<n;){var s=Math.floor(Math.random()*o.length);t+=o[s],e++}var r=2===d?1:0,r=i[Math.floor(r+Math.random()*(i.length-r))];t+=r,(.02<Math.random()||t!==LAST_SEED)&&(t="",r=Math.floor(Math.random()*seeds.length),t=seeds[r])}return LAST_SEED=t,t}}const Ghost=function(e,t=0,i=0,o=[]){var n=this;const s=[];this.inputs=[],s[0]={name:"logistics crate",geometry:()=>MODEL.logistics_crate()},s[1]={name:"ag-86",geometry:()=>MODEL.ag_86()};var r=t,t=i;const a=e.slice();this.tape=a;var c=new THREE.Vector3(0,0,1);const l=a[0].position.clone(),h=new THREE.Vector3;new THREE.Vector3(0,0,1);const u=new THREE.Vector3,p=new THREE.Vector3;new THREE.Vector3(0,5,0);this.position=new THREE.Vector3,this.direction=new THREE.Vector3,this.lookAt=l,this.normal=new THREE.Vector3;this.velocity=new THREE.Vector3;let E=s[r].geometry(),T=new THREE.MeshBasicMaterial({color:PAINT[t]}),m=new THREE.LineSegments(E,T);m.name="ghost_"+ghost.length,m.position.copy(a[0].position),scene.add(m);let d=new MODEL.emitter;d.connect(PAINT[i]);let g=o.slice();(g[4]<stage.best[4]||null==stage.best[4])&&(stage.best=g.slice()),uas.TARGETS.push(this),SPECTATE&&(uas.TARGET=1),this.reset=function(){TIME.reset(),d.reset(),n.update()},this.update=function(e,t){t=t<a.length-1?t:a.length-1,a[t].time;let i=a[t].U;0!==t&&0!==e||(i=!1),m.position.copy(l),m.lookAt(u),m.rotateOnAxis(c,a[t].rotation),m.updateMatrix(),GHOST_EMITTER&&d.update(i,l,h,n.velocity.length()),l.copy(a[t].position),h.copy(a[t].direction),p.copy(a[t].normal),u.copy(p),u.add(l),this.position.copy(l),this.direction.copy(h),this.normal.copy(p)},this.index=function(e){let t=0;if(e<=a[a.length-2].time)for(;a[t].time<=e;)t++;else t=a.length-1;return t},this.toggleEmitter=function(e=!0){e?d.connect():d.disconnect()},this.disconnect=function(){scene.remove(m),E.dispose(),T.dispose(),d.disconnect()},this.debug=function(){console.log(a)}},BUILD="0.0.6",DB_BUILD="006";window.onload=init,window.onresize=resize,window.fullscreenchange=resize,window.focus=resize;const seeds=["development mountain","haunted forest","sheep pass","pine forest","shinigami graveyard","tofu route","ego mountain","lotus mountain","prey first pass","ginko mountain","ghxst pass","ghxstly forest","sleeping forest","do it pass","mew mountain","ultra mountain","vr pass","ratty mountain","coffee forest","r3 mountain","low tunnel pass","ogj route","lyla forest","the lotus order","deadmans wonderland","zynra mountain","nephil pass","r3evaluate pass","coen mountain","hoekage mountain","tora tora pass","tora forest","olive forest"];let palette=[1052688,16777215,12698049,2894892,5308334,16740978,2393855,2201343,3424820,2201152,7168071,10066329,16756970];for(let e in palette){const Wg=new THREE.Color(palette[e]);palette[e]=Wg}let PAINT=[16777215,16760825,12910564,16758197,16383882,14267903,7727359],PAINT_NAME=["snow","sakura","melon","peach","bumblebee","lavender","ice"],LOADSTATUS=0,PERSONAL_BEST=!1,SEED_NAME="",CUSTOM_SEED="",SEED=Math.floor(2147483647*Math.random()),LAST_SEED="",scene,camera,renderer,stage,vehicle,control,ui,vhs,state,ghost=[];const TIMESTEP=1e3/60;let SCORE_LIMIT=99,GHOST_LIMIT=12,GHOST_SOFT_LIMIT=9,RAID_LIMIT=20,GHOST_PRIORITY=0,GHOST_EMITTER=!0,GHOST_TIME_STAMP=0,GHOST_TIME_START=0,UAS_IS_ACTIVE,UAS_ENABLED=!1,UAS_IS_TRACKING=!1,UAS_IS_FOLLOWING=!1,REGISTER=!1,UID=null,NAME="",UP,PLAY=!1,IMPORT=!1,BG=palette[0],FRAME=0,CURSOR=!1,FPS=0,COUNTER=0,TIMEOUT=0,DNF=!1,REASON="out of bounds",FULLSCREEN=!1,MODE=0,LOAD=0,LOADING=!1,MENU=!1,MOBILE=!1,CHALLENGE=!1,OBJECTIVES=[],UPDATES=[],HITBOX=!0,FIREBASE=!0,SCALE=1,RESIZE_SCALE=1,SNOW=!1,RAFID=0,GLOBAL_TS,GLOBAL_DT,GLOBAL_TS_START,GLOBAL_LAST_TS,MUSIC=!1,MUSIC_PAUSE=!1,MIXTAPE="low recordings 0.0.6 feature mix",sound,CHALLENGES=[],BATTLE=!1,SPECTATE=!1,PIXEL_SCALE=1;var firebaseConfig={apiKey:"AIzaSyB8RCC02kiLKX3Vm5bUCKDdYgKKVyMRh_0",authDomain:"ssio-live.firebaseapp.com",databaseURL:"https://ssio-live-default-rtdb.firebaseio.com",projectId:"ssio-live",storageBucket:"ssio-live.appspot.com",messagingSenderId:"205970490845",appId:"1:205970490845:web:fa37aac1e169e6feade234",measurementId:"G-54D3B95XY3"};function init(){window.addEventListener("touchstart",activateTouch),window.addEventListener("contextmenu",function(){event.preventDefault()}),scene=new THREE.Scene,scene.background=BG,UP=new THREE.Vector3(0,0,1),camera=new THREE.PerspectiveCamera,camera.up=UP,camera.position.z=2e3,camera.lookAt(0,0,0),camera.fov=70,camera.near=1e-5,camera.far=3e3,camera.name="Camera",scene.add(camera),renderer=new THREE.WebGLRenderer({logarithmicDepthBuffer:!0,antialias:!1,precision:"highp"}),renderer.setClearColor(BG),renderer.domElement.id="renderer",renderer.setSize(document.innerWidth,document.innerHeight),document.body.appendChild(renderer.domElement),control=new Control,control.connect(),ui=new UI,stage=new Stage,vehicle=new Vehicle,vhs=new VHS,state=new State,state.login(),state.checksave(),state.decodeURL(),uas=new UAS,uas.connect(),ui.onload=function(){ui.format(1,"#50ffae"),ui.format(2,"#999999"),ui.format(3,"#75e8ff"),ui.format(4,"#ff7272"),ui.format(5,"#eeeeee"),camera.position.set(0,25,10),camera.lookAt(0,0,0),resize(),main(),state.intro()}}function activateTouch(){MOBILE=!0,window.removeEventListener("touchstart",activateTouch)}function resize(){var e=1===window.devicePixelRatio&&600<=window.innerWidth&&600<=window.innerHeight?2:1,t=window.innerWidth,i=window.innerHeight;camera.aspect=t/i,camera.updateProjectionMatrix(),ui.resize(t,i,e,PIXEL_SCALE),state.resize(t,i,e)}function main(){if(window.requestAnimationFrame(main),RAFID=window.performance.now(),!PLAY||vehicle.IMPORT||SPECTATE)if(vehicle.REPLAY){if(DT(),stage.update(),vehicle.update(),!vehicle.IMPORT){uas.update(vehicle.TIMESTAMP);for(let e=0;e<ghost.length;e++)ghost[e].update(vehicle.TIMESTAMP,vehicle.FRAME),SPECTATE&&vehicle.TIMESTAMP>ghost[0].tape[ghost[0].tape.length-1].time+5e3&&vehicle.reset(!0)}}else if(LOADING||vhs.SCAN&&!PLAY)camera.up.set(0,0,1),camera.position.applyAxisAngle(camera.up,.01),camera.lookAt(new THREE.Vector3),LOADING&&state.loading(),state.scanning();else{if(SPECTATE||vehicle.IMPORT){let e="";for(;e.length<Math.floor(RAFID/500)%4;)e+=".";ui.clear(),ui.text("importing ghost data"+e,16,16),stage.update()}camera.up.set(0,0,1),camera.position.applyAxisAngle(camera.up,.01),camera.lookAt(new THREE.Vector3,0,0,0)}else{vehicle.update();for(let e=0;e<ghost.length;e++)vehicle.START?ghost[e].update(vehicle.TIMESTAMP,vehicle.FRAME):ghost[e].update(0,0);uas.update(vehicle.TIMESTAMP),MENU||REGISTER||state.update(),!MOBILE||MENU||DNF||ui.dpad(),control.RESET&&!MENU&&(state.reset(),control.RESET=!1),stage.update()}renderer.render(scene,camera),ui.update(control.touches)}firebase.initializeApp(firebaseConfig),firebase.analytics();const MODEL={ag_86:function(){geometry=new THREE.Geometry;var e={SIDE_FRONT:.3,SIDE_BACK:.45,BODY_FRONT:1.2,BODY_BACK:-.75,SIDE_WING:1,WING_BACK:-1.4,WING_BOTTOM:.4,TOP:1,BOTTOM:-.1};return geometry.vertices.push(new THREE.Vector3(e.SIDE_BACK,e.BODY_BACK,e.TOP)),geometry.vertices.push(new THREE.Vector3(e.SIDE_FRONT,e.BODY_FRONT,e.TOP)),geometry.vertices.push(new THREE.Vector3(-e.SIDE_BACK,e.BODY_BACK,e.TOP)),geometry.vertices.push(new THREE.Vector3(-e.SIDE_FRONT,e.BODY_FRONT,e.TOP)),geometry.vertices.push(new THREE.Vector3(e.SIDE_FRONT,e.BODY_FRONT,e.TOP)),geometry.vertices.push(new THREE.Vector3(-e.SIDE_FRONT,e.BODY_FRONT,e.TOP)),geometry.vertices.push(new THREE.Vector3(e.SIDE_BACK,e.BODY_BACK,e.TOP)),geometry.vertices.push(new THREE.Vector3(-e.SIDE_BACK,e.BODY_BACK,e.TOP)),geometry.vertices.push(new THREE.Vector3(-e.SIDE_FRONT,e.BODY_FRONT,e.TOP)),geometry.vertices.push(new THREE.Vector3(-e.SIDE_WING,e.BODY_BACK,e.BOTTOM)),geometry.vertices.push(new THREE.Vector3(-e.SIDE_BACK,e.BODY_BACK,e.TOP)),geometry.vertices.push(new THREE.Vector3(-e.SIDE_WING,e.BODY_BACK,e.BOTTOM)),geometry.vertices.push(new THREE.Vector3(e.SIDE_FRONT,e.BODY_FRONT,e.TOP)),geometry.vertices.push(new THREE.Vector3(e.SIDE_WING,e.BODY_BACK,e.BOTTOM)),geometry.vertices.push(new THREE.Vector3(e.SIDE_BACK,e.BODY_BACK,e.TOP)),geometry.vertices.push(new THREE.Vector3(e.SIDE_WING,e.BODY_BACK,e.BOTTOM)),geometry.vertices.push(new THREE.Vector3(e.SIDE_BACK,e.BODY_BACK,e.TOP)),geometry.vertices.push(new THREE.Vector3(e.SIDE_BACK,e.WING_BACK,e.WING_BOTTOM)),geometry.vertices.push(new THREE.Vector3(-e.SIDE_BACK,e.BODY_BACK,e.TOP)),geometry.vertices.push(new THREE.Vector3(-e.SIDE_BACK,e.WING_BACK,e.WING_BOTTOM)),geometry.vertices.push(new THREE.Vector3(e.SIDE_BACK,e.WING_BACK,e.WING_BOTTOM)),geometry.vertices.push(new THREE.Vector3(-e.SIDE_BACK,e.WING_BACK,e.WING_BOTTOM)),geometry.vertices.push(new THREE.Vector3(e.SIDE_BACK,e.WING_BACK,e.WING_BOTTOM)),geometry.vertices.push(new THREE.Vector3(e.SIDE_WING,e.BODY_BACK,e.BOTTOM)),geometry.vertices.push(new THREE.Vector3(-e.SIDE_BACK,e.WING_BACK,e.WING_BOTTOM)),geometry.vertices.push(new THREE.Vector3(-e.SIDE_WING,e.BODY_BACK,e.BOTTOM)),geometry.center(),geometry.name="AG-86",geometry},logistics_crate:()=>{const e=(new THREE.Geometry).fromBufferGeometry(new THREE.EdgesGeometry(new THREE.BoxGeometry(1,2,1)));return e.name="Logistics Crate",e},emitter:function(){var t=this;this.maxLife=100;let a=0;const i=new THREE.Geometry;for(;i.vertices.length<t.maxLife;){let e=new THREE.Vector3(0,0,0);e.life=0,e.maxLife=t.maxLife,e.acc=new THREE.Vector3(0,0,0),i.vertices.push(e);var o=new THREE.Color(4294967040);i.colors.push(o)}i.verticesNeedUpdate=!0;let c=new THREE.Points(i,new THREE.PointsMaterial({size:.2,vertexColors:THREE.VertexColors,blending:THREE.AdditiveBlending,transparent:!0}));c.name="Emitter";let l=new THREE.Color;t.connect=(e=16777215)=>{scene.add(c),t.paint(e)},t.paint=(e=16777215)=>{let t=new THREE.Color(e);l=new THREE.Color,t.getHSL(l);for(let e=0;e<c.geometry.vertices.length;e++)c.geometry.colors[e].setHSL(l.h,l.s,0),c.geometry.vertices[e].life=0},t.reset=()=>{for(let e=0;e<c.geometry.colors.length;e++)c.geometry.colors[e].setHSL(l.h,l.s,0),c.geometry.vertices[e].life=0},t.disconnect=()=>{scene.remove(c),c.geometry.dispose(),c.material.dispose()},t.update=(e,t,i,o)=>{if(e){let e=0;for(;e<1;){c.geometry.vertices[a].copy(i),c.geometry.vertices[a].multiplyScalar(-1-Math.random()*o),c.geometry.vertices[a].add(t),c.geometry.vertices[a].life=c.geometry.vertices[a].maxLife;Math.random(),Math.random(),Math.random();var n=.1*-Math.random();c.geometry.vertices[a].acc.copy(i),c.geometry.vertices[a].acc.multiplyScalar(n),a++,a%=c.geometry.vertices.length,e++}}for(var s in c.geometry.vertices){var r;0<c.geometry.vertices[s].life&&(c.geometry.vertices[s].add(c.geometry.vertices[s].acc),--c.geometry.vertices[s].life,r=c.geometry.vertices[s].life/100,c.geometry.colors[s].setHSL(l.h,l.s,l.l*r)),c.geometry.vertices[s].life<=0&&(c.geometry.vertices[s].set(0,0,0),c.geometry.vertices[a].acc.x=0,c.geometry.vertices[a].acc.y=0,c.geometry.vertices[a].acc.z=0)}c.geometry.verticesNeedUpdate=!0,c.geometry.colorsNeedUpdate=!0,c.geometry.computeBoundingSphere()}}};var ImprovedNoise=function(){for(var T=[151,160,137,91,90,15,131,13,201,95,96,53,194,233,7,225,140,36,103,30,69,142,8,99,37,240,21,10,23,190,6,148,247,120,234,75,0,26,197,62,94,252,219,203,117,35,11,32,57,177,33,88,237,149,56,87,174,20,125,136,171,168,68,175,74,165,71,134,139,48,27,166,77,146,158,231,83,111,229,122,60,211,133,230,220,105,92,41,55,46,245,40,244,102,143,54,65,25,63,161,1,216,80,73,209,76,132,187,208,89,18,169,200,196,135,130,116,188,159,86,164,100,109,198,173,186,3,64,52,217,226,250,124,123,5,202,38,147,118,126,255,82,85,212,207,206,59,227,47,16,58,17,182,189,28,42,223,183,170,213,119,248,152,2,44,154,163,70,221,153,101,155,167,43,172,9,129,22,39,253,19,98,108,110,79,113,224,232,178,185,112,104,218,246,97,228,251,34,242,193,238,210,144,12,191,179,162,241,81,51,145,235,249,14,239,107,49,192,214,31,181,199,106,157,184,84,204,176,115,121,50,45,127,4,150,254,138,236,205,93,222,114,67,29,24,72,243,141,128,195,78,66,215,61,156,180],e=0;e<256;e++)T[256+e]=T[e];function m(e){return e*e*e*(e*(6*e-15)+10)}function d(e,t,i){return t+e*(i-t)}function g(e,t,i,o){var n=15&e,e=n<8?t:i,o=n<4?i:12==n||14==n?t:o;return(0==(1&n)?e:-e)+(0==(2&n)?o:-o)}return{noise:function(e,t,i){var o=Math.floor(e),n=Math.floor(t),s=Math.floor(i),r=255&o,a=255&n,c=255&s,l=(e-=o)-1,h=(t-=n)-1,u=(i-=s)-1,p=m(e),E=m(t),o=m(i),n=T[r]+a,s=T[n]+c,n=T[n+1]+c,r=T[1+r]+a,a=T[r]+c,c=T[r+1]+c;return d(o,d(E,d(p,g(T[s],e,t,i),g(T[a],l,t,i)),d(p,g(T[n],e,h,i),g(T[c],l,h,i))),d(E,d(p,g(T[s+1],e,t,u),g(T[a+1],l,t,i-1)),d(p,g(T[n+1],e,h,u),g(T[c+1],l,h,u))))}}};const profanity=(e,t)=>{let l=["616e616c","617373","6175746973","62616c73","62616c7a","626c77","626c6f776a6f62","626f6e6572","6269746368","746974","627574","6368696e616d656e","6368696e616d616e","6368696e6b","636f636b","63756d","63756e74","64696b","6469636b","64796b65","656a6163756c6174","6572656374696f6e","666167","666774","66676574","666774","66676f74","66617274","66656c6174696f","666f7265736b696e","666f72736b696e","34736b696e","666f7265736b6e","666f72736b6e","34736b6e","666b","66756b","667563","66636b","6675646765706163","66756765706163","667567706163","667564676570636b","66646770636b","676179","6761796c6f72","6761796c72","67796c7264","676f6f6b","68616e646a6f62","686562","6869746c6572","68746c72","6869746c72","68746c6572","6a696761","6a69676761","6a676761","6a676162","6a697a","6b696b65","6d617374657262617465","6d617374757262617465","6d6173747262617465","6d61737475726238","6d61737465726238","6d617374726238","6d6964676574","6a65726b6f66","6a61636b6f66","6a61636b6d656f66","626561746d656174","6265746d6574","6d6574626574","6d65617462656174","6d6f6c657374","6e617a69","6e7a69","6e6772","6e676572","6e6761","6e656772","6e6967","6e6767","6e7574","70616b69","70656e6973","70657276","7068756b","70687563","706863","70696d70","70697373","706f7263686d6f6e6b6579","707263686d6e6b79","706f7263686d6e6b79","707263686d6f6e6b6579","706f7263686d6e6b6579","707263686d6f6e6b6579","706f726e","70726963","707269636b","70726f737469","70757379","7075736965","7065646f","70646f","72617065","7261706973","726170696e","72656374756d","74617264","72696d696e67","72696d6a6f62","736578","7365636b73","7363726f74756d","736b616e6b","736c617665","736c7574","736f646f6d","73706963","73686974","736874","7375636b","737578","73756b73","7370756e6b","73706f6765","7377617374696b61","73797068","746573746963","74657374696b","77616e6b","77686f7265","7768747077","776869746570726964","77686974707264","7768697465706f77","77686974657077","77707777","79656c6f776d616e","7a696761626f","7a6970657268656164","6a65737573","6a77","6a6577","61726162","6d75736c696d","636872697374","736174616e","676f64","6c6f7264","616c6168","62756468","6269626c65","71756172616e"],h=["a4","g6","g9","s5","i1","l1","b8","t7","b6","s$","y$","g&","a&","b&","i!","i/","i\\","i?","g8","b8","s6","o0","e3"],i=e.toLowerCase();for(let e=0;e<i.length;e++){var o=i.charCodeAt(e);if(122<o||57<o&&o<61||o<33||40==o||41==o)return"";let c="";for(let t=e;t<i.length;t++){i.charAt(t);let e=i.charCodeAt(t);(48<=e&&e<=57||97<=e&&e<=122)&&(c+=e.toString(16));for(let e=0;e<l.length;e++){let o="",n="",s=[],r=0,a=0;for(let i=0;i<l[e].length;i+=2){let t=c.charAt(i+r)+c.charAt(i+1+r);var u=l[e].charAt(i)+l[e].charAt(i+1);if((t===o||t===n)&&0!==t.length&&(a++,0<a))for(;t===o||t===n;)r+=2,t=c.charAt(i+r)+c.charAt(i+1+r);if(t===u)s[i/2]=!0,o=t,n=u;else{s[i/2]=!1;for(let e=0;e<h.length;e++){var p=h[e].charCodeAt(1).toString(16),E=h[e].charCodeAt(0).toString(16);t===p&&(E===u?(s[i/2]=!0,o=p,n=u):E!==o&&E!==n||(a++,0<a&&(r+=2,i-=2)))}!1===s[i/2]&&(i=l[e].length)}}let t=0;for(let e=0;e<s.length;e++)if(!0===s[e]&&t++,t===s.length)return""}}}return e};function Stage(){var i=this;this.COMPLETE=!1,this.SNOW=!1,this.start=new THREE.Vector3,this.generate=new Generate,this.checkpoint=[],this.objectives=[],this.best=[],this.grid=[],this.dimension=2400,this.partitionDimension=16,this.partionDivision=this.dimension/this.partitionDimension,this.seed,this.snow={distance:200,height:100,limit:200,mesh:new THREE.Points(new THREE.Geometry,new THREE.PointsMaterial),init:function(){for(;i.snow.mesh.geometry.vertices.length<i.snow.limit;){let e=new THREE.Vector3;e.copy(camera.position),e.x+=Math.random()*i.snow.distance-i.snow.distance/2,e.y+=Math.random()*i.snow.distance-i.snow.distance/2,e.z+=Math.random()*i.snow.height-i.snow.height/2,i.snow.mesh.geometry.vertices.push(e)}i.snow.mesh.geometry.verticesNeedUpdate=!0,i.snow.mesh.geometry.computeBoundingSphere()},update:function(){for(let t=0;t<i.snow.mesh.geometry.vertices.length;t++){let e=i.snow.mesh.geometry.vertices[t];e.z-=.5*vehicle.DT(),(Math.abs(e.z-camera.position.z)>i.snow.height/2||Math.abs(e.x-camera.position.x)>i.snow.distance/2||Math.abs(e.y-camera.position.y)>i.snow.distance/2)&&(e.copy(camera.position),e.x+=Math.random()*i.snow.distance-i.snow.distance/2,e.y+=Math.random()*i.snow.distance-i.snow.distance/2,e.z+=Math.random()*i.snow.height-i.snow.height/2)}i.snow.mesh.geometry.verticesNeedUpdate=!0,i.snow.mesh.geometry.computeBoundingSphere()}};for(let e=0;e<4;e++)this.checkpoint[this.checkpoint.length]=new THREE.Mesh(new THREE.Geometry);this.connect=function(e=!1){if(camera.position.set(0,400,200),camera.far=2e3,camera.updateProjectionMatrix(),camera.lookAt(new THREE.Vector3),renderer.render(scene,camera),!e){this.name=this.generate.name();let e="";for(var t in this.name)e+=this.name.charCodeAt(t).toString();SEED=e}i.generate.connect(),COUNTER++},this.disconnect=function(){SNOW&&(scene.remove(i.snow.mesh),i.SNOW=!1),this.generate.disconnect(),this.generate.reset()},this.reset=function(e=!1){SEED++,i.best=[],i.COMPLETE=!1,i.disconnect(),i.generate=new Generate,i.connect(e)},this.preview=function(){window.setTimeout(0,0)},this.update=function(){this.SNOW&&this.snow.update()}}function State(){var c=this;let i,a;let t=0,o=0;this.custom_seed="";let n="#1#ffffff#334#",s=GHOST_LIMIT+"#1#",r=!0;this.SETTINGS=!1,this.STATE=function(){c.intro()},this.CHALLENGES={},this.CHALLENGER="",this.TIMELIST=[],this.BATTLE=[],this.PATH=!1,this.login=function(){var t=null;firebase.auth().onAuthStateChanged(e=>(e?(UID=e.uid,c.STATE(),vhs.requestName(UID,e=>{NAME=e,c.STATE()})):(UID=!1,c.STATE()),t))},this.register=function(e){ui.clear(),c.STATE=()=>{c.register(e)},REGISTER=!0,c.inputName(()=>{REGISTER=!1,vhs.export()},!0,"input name to save data")},this.resize=function(e,t){i=ui.width,a=ui.height,GHOST_SOFT_LIMIT=Math.floor((window.innerHeight/ui.scale/ui.row-34)/2)},this.wallet=function(){let e=vehicle.yen();ui.print("$ "+e.toString(),"2","1.0-4")},this.nav=function(e=()=>{ui.clear()}){ui.style=0,ui.sprite(8,64,8,8,"1.0-4+2p","2",8,8),ui.button("","2","2+4p","1.0-4","8",function(){c.menu(e)},!1)},this.title=function(e,t){c.breadcrumb(e,t),ui.sprite(16,64,8,8,"1.0-4+2p","2",8,8),ui.button("","1.0-7","2+4p","7","5",function(){r||ui.backdrop(!1),e(),MENU=!1,c.SETTINGS=!1},!1),MUSIC?(ui.style=1,ui.sprite(40,72,8,10,"1.0-14","2",8,10),ui.sprite(48,72,16,16,"1.0-19","2",16,16),ui.sprite(16,72,16,16,"1.0-10","2",16,16),ui.style=0,ui.button("","1.0-23","2+4p","7","5",function(){let e=document.getElementById("mp3_player");e.currentTime=Math.random()*e.duration,e.play(),c.STATE()},!1),ui.button("","1.0-14","2+4p","7","5",function(){document.getElementById("mp3_player").pause(),MUSIC=!1,MUSIC_PAUSE=!0,c.STATE()},!1)):(ui.style=2,ui.sprite(16,72,16,16,"1.0-10","2",16,16),ui.style=0,ui.button("","1.0-14","2+4p","7","5",function(){document.getElementById("mp3_player").play(),MUSIC=!0,c.STATE()},!1)),document.fullscreenEnabled,c.wallet()},this.breadcrumb=function(e,t){var i=void 0===t?function(){r||ui.backdrop(!1),e(),MENU=!1,c.SETTINGS=!1}:function(){c.menu(e),MENU=!0};ui.style=MUSIC?1:0;t=MUSIC?" low recordings 0.0.6 feature mix":" menu";ui.print(" "+t,"2","2"),ui.style=0,ui.print("<","2","2"),ui.button("","2","2+4p","7","8",i,!1)},this.menu=function(e){MENU=!0,ui.style=0,c.STATE=()=>{c.menu(e)},r||ui.backdrop(),ui.clear(),c.title(e),ui.sprite(0,0,1,1,"2","6","1.0-4",1),SPECTATE?(ui.print(" > view spectator controls","2","8"),ui.button("","2","8+4p","1.0-4","5",function(){c.uas(!0)},!1)):(ui.print(" > modify vehicle","2","8"),ui.button("","2","8+4p","1.0-4","5",function(){c.vehicle(e)},!1)),ui.sprite(0,0,1,1,"2","11","1.0-4",1),ui.print(" > settings","2","13"),ui.button("","2","13+4p","1.0-4","5",function(){c.settings(e)},!1),ui.sprite(0,0,1,1,"2","16","1.0-4",1);let t=8;var i;SPECTATE?(i=uas.AUTOPILOT?"disable":"enable",ui.button(i+" autopilot","2","1.0-2-"+t,"1.0-4","6",function(){ui.backdrop(!1),uas.AUTOPILOT=!uas.AUTOPILOT,c.replay()},!0),t+=8,ui.button("deploy vehicle","2","1.0-2-"+t,"1.0-4","6",function(){ui.backdrop(!1),SPECTATE=!1,c.STATE=()=>{},vehicle.reset(!1),c.reset(),PLAY=!0,vehicle.START=!1,vehicle.disconnect(),vehicle.connect(stage.start,stage.surface,!1),c.play()},!0)):(PLAY||vehicle.REPLAY)&&(ui.button("restart stage","2","1.0-2-"+t,"1.0-4","6",function(){ui.backdrop(!1),c.reset()},!0),t+=8,ui.button("next stage","2","1.0-2-"+t,"1.0-4","6",function(){ui.backdrop(!1),c.next()},!0)),c.discord()},this.intro=function(){var e;c.STATE=()=>{c.intro()},r=!0,ui.clear(),ui.print("specialstage.io","2","2"),ui.print("-","2","4"),ui.style=0,CHALLENGE?(ui.style=4,ui.print("challenge detected!","2","12"),ui.style=0,e=null!==c.CHALLENGER&&0<c.CHALLENGER.length?c.CHALLENGER:"...",ui.style=2,ui.print("rival:","2","15"),ui.style=0,ui.print(e,"9","15"),vhs.requestName(c.CHALLENGES.uid,function(e){c.CHALLENGER=e,c.STATE()}),ui.style=2,ui.print("seed:","2","17"),ui.style=0,ui.print(c.CHALLENGES.seed,"9","17")):CUSTOM_SEED&&(ui.style=3,ui.print("seed detected","2","13",1),ui.style=0,ui.print("> "+c.custom_seed,"2","16",1)),null!==UID&&!1===UID||""!==NAME?null!==NAME&&""!==NAME?(ui.style=5,ui.print("welcome back!","2","6"),ui.style=0,ui.print("> "+NAME,"2","9"),ui.style=2,ui.print("[edit]",NAME.length+"+5","9"),ui.style=0,ui.button("","2","9+4p",NAME.length+"+9","4",function(){c.inputName(c.intro)},!1)):(!1===UID&&(""===NAME||null===NAME)||!1!==UID&&null===NAME)&&(ui.style=2,ui.print("user data not detected","2","6"),ui.style=0,ui.print("> [register/sign in]","2","9"),ui.button("","2","9+4p","1.0-4","4",function(){c.inputName(c.intro)},!1)):(ui.style=2,ui.print("> loading user data...","2","6"),ui.style=0),ui.style=2,ui.print(BUILD,"2","1.0-4"),ui.style=0,c.nav(function(){c.intro()}),ui.print("menu","1.0-9","2"),ui.button("","1.0-9","2+4p","4","5",function(){c.menu(c.intro)},!1),c.discord(),c.startButton()},this.startButton=function(){ui.button("start","2","1.0-12+"+(2*(RESIZE_SCALE-1)).toString(),"1.0-4","8",function(){ui.clear(),r=!1,ui.renderer.style.background="transparent",ui.renderer.style.animation="none",STATE=()=>{},START=!0,FIREBASE&&firebase.analytics().logEvent("game_start"),stage.connect(),c.load()})},this.discord=function(){ui.style=3,ui.sprite(0,72,16,16,"1.0-12","1.0-5+4p",16,16),ui.print("discord","1.0-9","1.0-4"),ui.link("","1.0-13","1.0-5","12","4","https://discord.gg/ACewNWH"),ui.style=0},this.load=function(){c.STATE=()=>{c.target(),c.setBattleName()},c.TIMELIST=[],vhs.scan(stage.name,function(i){for(let t=0;t<i.length;t++)c.TIMELIST[t]={uid:i[t].uid,utc:i[t].utc,time:i[t].time,name:"..."},vhs.requestName(i[t].uid,function(e){c.TIMELIST[t].name=e,c.STATE()}),vhs.checkTime(UID,i[t].uid,i[t].time);var t=c.TIMELIST.length<GHOST_LIMIT?c.TIMELIST.length:GHOST_LIMIT;let o=[];switch(GHOST_PRIORITY){case 0:o=i.slice(0,t);break;case 1:let e=i.slice();for(;o.length<t;){var n=Math.floor(Math.random()*e.length);o.push(Object.assign({},e[n])),e.splice(n,1)}}c.BATTLE=o.slice(),c.STATE()}),LOADING=!0,c.target(),t=0},this.ready=function(){LOADING=!1,c.STATE()},this.play=function(){ui.clear(),c.nav(c.play),MENU=!1,ui.style=0},this.complete=function(){MENU=!0,ui.clear(),c.STATE=()=>{},c.nav(c.complete);var e="stage complete!";ui.style=0,ui.print(e,"0.5-"+2*Math.round(e.length/2),"0.3-1",2),ui.style=0,stage.COMPLETE=!0,window.setTimeout(function(){!1===UID||null===UID?(c.register(),c.STATE=()=>{c.results(),vehicle.replay()}):(c.STATE=()=>{c.results()},vehicle.REPLAY||(c.STATE=()=>{},vhs.export(c.results)))},2e3),FIREBASE&&(e=vehicle.param().model+" ("+(vehicle.param().power+1)+"/"+(vehicle.param().drag+1)+"/"+(vehicle.param().sensitivity+1)+"/"+(vehicle.param().ease+1)+")",firebase.analytics().logEvent("stage_complete",{operator_id:NAME,time:vehicle.AT(),penalty:vehicle.PENALTY(),score:vehicle.AT()+vehicle.PENALTY(),seed:stage.name,rating:Math.round(stage.generate.DISTANCE/(vehicle.AT()+vehicle.PENALTY())),distance:stage.generate.DISTANCE,vehicle:e}))},this.results=function(){c.STATE=()=>{c.results()},ui.clear(),ui.style=0,MENU=!0;let t=0;var i=vehicle.CHECKPOINT[4]-1e4*vehicle.CHECKPOINT[5];if((i<PERSONAL_BEST||!1===PERSONAL_BEST)&&(PERSONAL_BEST=i),0<c.TIMELIST.length){for(let e=0;e<c.TIMELIST.length;e++)if(i<c.TIMELIST[e].time){t=e+1;break}0==t&&(t=c.TIMELIST.length+1)}c.nav(c.results),ui.style=5,ui.print("stage complete! "+stage.name,"2","2"),ui.style=0;var e=ui.time(i);ui.print(e,"2","5",2);var o=vehicle.overwrite(vehicle.CHECKPOINT,stage.best,!1);0!=t?ui.print("rank "+t,2*e.length+"+3".toString(),"5+4p"):o?(o=CHALLENGE?"challenge victory!":"new record!",ui.style=1,ui.print(o,2*e.length+"+3".toString(),"5+4p"),ui.style=0):CHALLENGE&&ui.print("challenge failed",2*AT.length+"+3".toString(),"5+4p");let n=9;var s=vehicle.CHECKPOINT;if(320<a){for(let t=1;t<s.length-1;t++){ui.style=5,ui.print("cp "+t,"2",n+"+"+t.toString());t;let e=s[t];var r=c.split(t);ui.print(r,"0.5+1",n+"+"+t.toString()),"number"==typeof s[t]?(ui.style=0,e=ui.time(s[t])):(ui.style=4,e="penalty",d=""),ui.print(e,"0.5 -1-"+e.length.toString(),n+"+"+t.toString()),ui.style=0,n+=1}n+=5}1===t&&(ui.style=4,ui.print("new record!","2",n.toString(),2),ui.style=0),ui.button("issue challenge","0.5+1","1.0-20","0.5-3","4",c.challenge),ui.button("modify vehicle","2","1.0-20","0.5-3","4",()=>{ui.backdrop(),c.vehicle(c.results)}),ui.button("next stage","2","1.0-12","1.0-4","8",function(){c.next()}),ui.button("restart stage","2","1.0-4","0.5-3","4",function(){c.reset("complete")}),ui.button("view replay","0.5+1","1.0-4","0.5-3","4",function(){MENU=!1,uas.replay(),c.replay()})},this.checkpoint=function(e=!1){ui.clear(),ui.style=0,c.nav(()=>{c.checkpoint(e)});let t="";e?t+="missed checkpoint X "+Math.abs(vehicle.CHECKPOINT[5]):t=this.split(vehicle.OBJECTIVE),ui.text(t,16,32),ui.style=0},this.split=function(e){let t="";var i=stage.best[e]-vehicle.CHECKPOINT[e];let o=2,n="";return Number.isNaN(i)?void 0===vehicle.CHECKPOINT[e]?(o=4,t+="- 100 sec"):void 0===stage.best[e]&&stage.best[5]<0?(o=1,t+="+ 100 sec"):void 0===stage.best[e]&&(o=1,t+="new time!"):(0<i?(n="+ ",o=1):i<0?(n="- ",o=4):n="+ ",i=Math.abs(i),t+="( "+n+ui.time(i)+" )"),ui.style=o,t},this.battle=function(){var e=new Ghost(vhs.save(vhs.tape),vehicle.MODEL,vehicle.PAINT);ghost.push(e),c.reset()},this.replay=function(){if(!vehicle.IMPORT&&!PLAY){c.STATE=()=>{c.replay()},ui.clear(),SPECTATE?c.nav(()=>{c.replay()}):c.nav(c.results),uas.AUTOPILOT?c.autopilot():c.drone();for(let e=ui.style=0;e<4;e++){var t="7+"+(4*e).toString(),i=e===uas.CAM-1?48:40;ui.button("",t+"-10p","1.0-4+4p","3","4",function(){uas.CAM=e+1,c.STATE()},!1),ui.sprite(i,64,8,8,t,"1.0-4",8,8)}ui.style=0;var e=(uas.AUTOPILOT||uas.TARGETING)&&0<uas.TARGET&&0<uas.TARGETS.length?c.TIMELIST[uas.TARGET-1].name:NAME;(uas.AUTOPILOT||uas.TARGETING)&&ui.print(e,"2","1.0-7"),ui.button("","0","1.0-8+4p","20","4",()=>{(uas.TARGETING||uas.AUTOPILOT)&&(uas.TARGET+=1,uas.TARGET%=uas.TARGETS.length,c.STATE())},!1)}},this.autopilot=function(){ui.style=0,ui.style=0<uas.camera[uas.CAM].pov?4:2,ui.sprite(72,64,8,8,"3","1.0-4",8,8),ui.button("","3-10p","1.0-4+4p","3","4",()=>{uas.POV=(uas.POV+1)%3,c.STATE()},!1),SPECTATE||(ui.print("<","2","2"),ui.button("","2","2+4p","7","8",function(){c.results(()=>{c.replay()})},!1))},this.drone=function(){ui.style=uas.TARGETING?4:2,ui.sprite(64,64,8,8,"3","1.0-4",8,8),ui.button("","3-10p","1.0-4+4p","3","4",()=>{uas.TARGETING=!uas.TARGETING,c.STATE()},!1)},this.next=function(){ui.clear(),LOADING=!0,CHALLENGE=!1,BATTLE=!1,CUSTOM_SEED=!1,c.PATH=!1,custom_seed="",stage.name="",c.BATTLE=[],PERSONAL_BEST=!1,window.history.pushState("","","/"),renderer.clear(),vehicle.REPLAY=!1,vehicle.RESET=!0,vehicle.disconnect();for(let e=0;e<ghost.length;e++)ghost[e].disconnect();uas.reset(!0),ghost=[],stage.SNOW&&scene.remove(stage.snow.mesh),stage.reset(),MENU=!1,PLAY=!1,vhs.PLAY=!1,c.load(),FIREBASE&&firebase.analytics().logEvent("next_stage")},this.dnf=function(){c.STATE=()=>{c.dnf()},ui.backdrop(!1),ui.clear(),c.nav(c.dnf),FIREBASE&&firebase.analytics().logEvent("dnf"),ui.print("dnf","0.5-3+3p","0.5-8",2),ui.button("restart stage?","2","0.5+8","1.0-4","1.0-4",function(){c.reset("dnf")},!1)},this.reset=function(e="reset"){ghost.index=0,ui.clear(),c.nav(c.play),PLAY=!0,MENU=!1,vehicle.reset(!1);for(let e=0;e<ghost.length;e++)ghost[e].reset();FIREBASE&&firebase.analytics().logEvent("stage_restart",{status:e})},this.hide=function(e){},this.update=function(){MENU||!PLAY||DNF||(ui.delete(16,16,i-64,16),ui.delete(16,a-32,64,16),ui.text(ui.time(vehicle.AT()),16,16),ui.text(vehicle.SPEED.toString(),16,a-32))},this.loading=function(){let e="";for(;e.length<Math.floor(RAFID/500)%4;)e+=".";MENU||(ui.delete(16,16,160,8),ui.style=2,ui.text("stage generating"+e,16,16),ui.style=0),t++},this.scanning=function(){if(0===state.TIMELIST.length&&vhs.SCAN&&!MENU){ui.delete(16,72,88,8);let e="";for(;e.length<Math.floor(RAFID/500)%4;)e+=".";ui.style=5,ui.text("scanning"+e,16,72)}},this.target=function(){ui.clear(),c.STATE=()=>{c.target()},c.nav(c.target);var o,n,e=stage.name,t=()=>{ui.clear(),stage.SNOW&&scene.add(stage.snow.mesh),c.STATE=()=>{},stage.generate.END=!1,c.play(),vehicle.SPECTATE=!1,PLAY=!0,vehicle.connect(stage.start,stage.surface,!1),c.import(),FIREBASE&&firebase.analytics().logEvent("stage_start")};if(LOADING||(ui.style=2,ui.print("stage generated.","2","2"),vhs.SCAN?(ui.style=2,ui.button("ready (no data)","2","1.0-10","1.0-4","8",function(){t()})):(ui.style=0,ui.button("ready","2","1.0-10","1.0-4","8",function(){t()}),ui.style=4,ui.style=1,0<c.BATTLE.length&&ui.button("spectate!","1.0-14","1.0-18","12","3",function(){UAS_IS_TRACKING=!0,UAS_IS_ACTIVE=!0,PLAY=!1,stage.generate.END=!1,stage.SNOW&&scene.add(stage.snow.mesh),ui.style=0,vehicle.connect(stage.start,stage.surface),SPECTATE=!0,c.import(),GHOST_TIME_START=GHOST_TIME_STAMP,ui.clear(),scene.add(stage.generate.stars),FIREBASE&&firebase.analytics().logEvent("spectate_start")},!1))),ui.style=5,ui.print(e,"2","5-1p",2),ui.style=0,0!==c.TIMELIST.length||!vhs.SCAN)if(0!==c.TIMELIST.length){let i=c.TIMELIST.slice();for(let t=0;t<i.length;t++)for(let e=0;e<i.length;e++)i[t].time<=i[e].time&&i[t].utc<i[e].utc&&t>e&&(o={},Object.assign(o,i[t]),n={},Object.assign(n,i[e]),i[t]=n,i[e]=o);ui.style=2,ui.print("best time:","2","9"),ui.style=0,ui.print(ui.time(i[0].time),"2","12",2),ui.style=5;var e=i.length<GHOST_SOFT_LIMIT,s=e?i.length:GHOST_SOFT_LIMIT,e=e?0:i.length-GHOST_SOFT_LIMIT;for(let e=0;e<s;e++)ui.print(e+1+". "+i[e].name,"2","16+"+2*e),ui.print(ui.time(i[e].time),"18","16+"+2*e);0<e&&ui.print("+ "+e+" more entries","2",2*s+"+17")}else ui.style=2,ui.print("no entries found.","2","9"),ui.style=0},this.setBattleName=function(){for(let e=0;e<c.BATTLE.length;e++)c.BATTLE[e].name=c.TIMELIST[e].name},this.import=function(){c.setBattleName();for(let o=0;o<c.BATTLE.length;o++)vehicle.IMPORT=!0,vhs.import(stage.name+"/"+c.BATTLE[o].uid,function(t){c.BATTLE[o].IMPORT_BUFFER=[],vehicle.INPUTS=[],c.BATTLE[o].data=[],c.BATTLE[o].param={power:t.param.power,drag:t.param.drag,sensitivity:t.param.sensitivity,model:t.param.model,paint:t.param.paint},c.BATTLE[o].cp=t.cp;for(let e=0;e<t.debug.length;e++){var i={time:t.debug[e].time,U:t.debug[e].U,D:t.debug[e].D,L:t.debug[e].L,R:t.debug[e].R};c.BATTLE[o].data.push({U:t.debug[e].U,D:t.debug[e].D,L:t.debug[e].L,R:t.debug[e].R,time:t.debug[e].time}),c.BATTLE[o].IMPORT_BUFFER.push(i)}o===c.BATTLE.length-1&&vehicle.import()})},this.uasComputer=function(){ui.clear(),ui.style=0;var e,t=uas.AUTOPILOT?"enabled":"disabled";ui.print("autopilot "+t,"2","2"),uas.AUTOPILOT?(e=state.TIMELIST[uas.data().target].name,ui.print("targeting: "+e,"2","4")):(e=0<ghost.length?state.TIMELIST[uas.data().target].name:"disabled",ui.print("targeting: "+e,"2","4"),ui.style=2,e=uas.CTRL||control.SHIFT?"roll":"yaw",ui.print("ctrl: "+e,"2","1.0-4"),ui.button("","0","1.0-4+4p","14","4",function(){c.uas(!0),uas.tutorial=!0},!1),ui.style=0)},this.uas=function(e){ui.clear(),ui.style=0,c.STATE=()=>{c.uas()},ui.backdrop(),ui.sprite(16,64,8,8,"1.0-4+2p","2",8,8),ui.button("","2","2","1.0","4",function(){ui.backdrop(!1),c.replay()},!1),ui.style=0,ui.print("spectator controls","2","2"),ui.print("pilot mode","2","6"),ui.style=2,ui.print("arrow            pitch/yaw/roll","2","10"),ui.print("shift + arrow    roll/yaw modifier","2","12"),ui.print("space            power +","2","14"),ui.print("shift + space    power -","2","16"),ui.print("ctrl:            roll/yaw toggle","2","18"),ui.print("r                reset","2","20"),ui.print("t                targeting mode toggle","2","22"),ui.print("shift + arrow    change target (targeting)","2","24"),ui.style=0},this.timelist=function(){ui.style=0},this.save=function(){var e=NAME+"#"+vehicle.MODEL+"#"+vehicle.PAINT+"#"+vehicle.param().power+vehicle.param().drag+ +vehicle.param().sensitivity+"#"+Date.now();e!==n&&(n=e,c.cSave("SAVE",n))},this.vehicle=function(i){c.STATE=()=>{c.vehicle(i)},MENU=!0,ui.clear(),c.title(function(){i(),c.save()},function(){c.menu(),sv()}),vehicle.REPLAY&&c.reset();let o=[];var e=vehicle.param();o.push({id:"power",value:e.power,funct:function(e){vehicle.tune.power(e)}}),o.push({id:"drag",value:e.drag,funct:function(e){vehicle.tune.drag(e)}}),o.push({id:"sensitivity",value:e.sensitivity,funct:function(e){vehicle.tune.sensitivity(e)}});var n="2";ui.sprite(0,0,1,1,n,"8+-5+3","1.0-2-2",1),ui.print("model",n,"8+"),ui.print(vehicle.models()[vehicle.MODEL].name,"2+8","8+"),ui.sprite(0,0,1,1,n,"8++3","1.0-2-2",1),ui.button(">","1.0-6","8++4p","4","4",function(){vehicle.MODEL+=1,1<vehicle.MODEL&&(vehicle.MODEL=0),vehicle.body(),c.vehicle(i)},!1),ui.button("<","1.0-12","8++4p","4","4",function(){--vehicle.MODEL,vehicle.MODEL<0&&(vehicle.MODEL=1),vehicle.body(),c.vehicle(i)},!1),ui.sprite(0,0,1,1,n,"8+5+-5+3","1.0-2-2",1),ui.print("paint",n,"8+5+"),ui.print(PAINT_NAME[vehicle.PAINT],"10","8+5+"),ui.sprite(0,0,1,1,n,"8+5++3","1.0-2-2",1),ui.button(">","1.0-6","8+5++4p","4","4",function(){vehicle.PAINT+=1,vehicle.PAINT>PAINT.length-1&&(vehicle.PAINT=0),vehicle.paint(),c.vehicle(i)},!1),ui.button("<","1.0-12","8+5++4p","4","4",function(){--vehicle.PAINT,vehicle.PAINT<0&&(vehicle.PAINT=PAINT.length-1),vehicle.paint(),c.vehicle(i)},!1);for(let t=0;t<o.length;t++){var s="8+5+5+"+(5*t).toString();ui.print(o[t].id,n,s),ui.sprite(0,0,1,1,n,s+"+3","1.0-2-2",1);for(let e=0;e<6;e++){var r="1.0-18+"+(3*e).toString(),a=e<=o[t].value?48:40;ui.button("",r+"-10p",s+"+4p","3","4",function(){o[t].funct(e),c.vehicle(i)},!1),ui.sprite(a,64,8,8,r,s,8,8)}}},this.scan=function(e,t){},this.settings=function(e){c.STATE=()=>{c.settings(e)},c.SETTINGS=!0;var t=HITBOX?1:0,i=UAS_ENABLED?1:0;s=GHOST_LIMIT+"#"+GHOST_PRIORITY+"#"+t+"#"+i+"#",c.cSave("SETTINGS",s),ui.clear(),r||ui.backdrop(),c.title(e,c.menu),ui.sprite(0,0,1,1,"2","6","1.0-4",1),ui.print("ghost config","2","8"),ui.print("[edit]","1.0-2-6","8"),ui.button("","2","8+4p","1.0-4","5",function(){c.ghostConfig(e)},!1),ui.sprite(0,0,1,1,"2","11","1.0-4",1),MOBILE?(o=HITBOX?"enabled":"disabled",ui.print("display touch hitboxes","2","13"),ui.print(o,"1.0-2-"+o.length,"13"),ui.sprite(0,0,1,1,"2","21","1.0-4",1),ui.button("","2","13+4p","1.0-4","5",function(){HITBOX=!HITBOX,c.settings(e)},!1)):(ui.print("keybindings","2","13"),ui.print("arrow / wasdr","1.0-15","13"),ui.sprite(0,0,1,1,"2","21","1.0-4",1)),ui.sprite(0,0,1,1,"2","16","1.0-4",1),ui.print("pixel scale","2","18"),ui.print(""+PIXEL_SCALE,"1.0-18","18"),ui.button("+","1.0-6","18+4p","4","4",function(){PIXEL_SCALE<2&&(PIXEL_SCALE+=.5),ui.style=0,c.settings(e),resize()},!1),ui.button("-","1.0-12","18+4p","4","4",function(){1<PIXEL_SCALE&&(PIXEL_SCALE-=.5),ui.style=0,c.settings(e),resize()},!1),ui.sprite(0,0,1,1,"2","26","1.0-4",1),ui.print("camera mode","2","23");var o=vehicle.FPV?"fpv":"tpv";ui.print(o,"1.0-6","23"),ui.button("","2","23+4p","1.0-4","5",function(){vehicle.FPV=!vehicle.FPV,c.settings(e)},!1),ui.print("www.procedural.ca","2","1.0-10"),ui.print("www.ginko.ltd","2","1.0-8"),c.discord(),ui.style=0},this.ghostConfig=function(e,t){c.STATE=()=>{c.ghostConfig(e)};var i=HITBOX?1:0,o=UAS_ENABLED?1:0;s=GHOST_LIMIT+"#"+GHOST_PRIORITY+"#"+i+"#"+o,c.cSave("SETTINGS",s),ui.clear(),r||ui.backdrop(),c.title(e,()=>{c.settings(e)}),ui.sprite(0,0,1,1,"2","6","1.0-4",1),ui.print("ghost name","2","8"),ui.print(NAME,"1.0-13-"+NAME.length,"8"),ui.print("[edit]","1.0-8","8"),ui.button("","2","9+4p","1.0-4","4",function(){c.inputName(()=>{c.ghostConfig(e)},!1)},!1),ui.sprite(0,0,1,1,"2","11","1.0-4",1),ui.print("ghost limit","2","13");o=GHOST_LIMIT.toString();ui.print(o,"1.0-13-"+o.length,"13"),ui.button(">","1.0-6","13+4p","4","4",function(){GHOST_LIMIT<20&&(GHOST_LIMIT+=1),c.ghostConfig(e)},!1),ui.button("<","1.0-12","13+4p","4","4",function(){0<GHOST_LIMIT&&--GHOST_LIMIT,c.ghostConfig(e)},!1),ui.sprite(0,0,1,1,"2","16","1.0-4",1),ui.print("ghost priority","2","18");o=0===GHOST_PRIORITY?"best":"random";ui.print(o,"1.0-13-"+o.length,"18"),ui.button(">","1.0-6","18+4p","4","4",function(){GHOST_PRIORITY+=1,1<GHOST_PRIORITY&&(GHOST_PRIORITY=0),c.STATE()},!1),ui.button("<","1.0-12","18+4p","4","4",function(){--GHOST_PRIORITY,GHOST_PRIORITY<0&&(GHOST_PRIORITY=1),c.STATE()},!1),ui.sprite(0,0,1,1,"2","21","1.0-4",1),ui.print("ghost particles","2","23");o=GHOST_EMITTER?"enabled":"disabled";ui.print(o,"1.0-2-"+o.length,"23"),ui.button("","2","23+4p","1.0-4","4",function(){GHOST_EMITTER=!GHOST_EMITTER;for(let e=0;e<ghost.length;e++)ghost[e].toggleEmitter(GHOST_EMITTER);c.ghostConfig(e)},!1),ui.sprite(0,0,1,1,"2","26","1.0-4",1)},this.controls=function(e){ui.clear(),c.title(e,c.menu)},this.fullscreen=function(){document.fullscreenElement?document.exitFullscreen&&document.exitFullscreen():document.documentElement.requestFullscreen()},this.prompt=function(){ui.clear(),ui.print("specialstage.io","4","4",2),ui.print("-","4","8",2)},this.challenge=function(e){ui.clear(),c.nav(function(){c.challenge()},c.menu),ui.print("issue challenge url","2","2"),ui.print("-","2","4"),ui.style=2,ui.print("issued by","2","6"),ui.style=0,ui.print("> "+NAME,"2","9"),ui.style=2,ui.print("[edit]",NAME.length+"+9","9"),ui.button("","2","9+4p",NAME.length+"+5","4",function(){c.inputName(c.challenge,!1)},!1),ui.style=2,ui.print("seed","2","13"),ui.style=5,ui.print(stage.name,"2","15"),ui.style=2,ui.print("time","2","19");var t=ui.time(vehicle.CHECKPOINT[4]-1e4*vehicle.CHECKPOINT[5]);ui.style=5,ui.print(t,"2","21"),ui.style=0,ui.button("copy challenge url","1","1.0-8","1.0-2","8",function(){ui.clear(),c.encodeURL(),window.setTimeout(c.results,2e3)})},this.appearance=function(){ui.clear(),c.breadcrumb(this.vehicle,this.state),c.nav(function(){c.appearance()},c.menu)},this.inputName=function(e,t=!1,i="enter display name:"){c.STATE=()=>{c.inputName(e,t,i)},ui.clear(),MENU=!0,t?c.nav(function(){e()},c.menu):c.title(e),ui.print(i,"2","2"),ui.textinput(NAME,"2","4","1.0-2","6","operator_id");const o=document.getElementById("operator_id");ui.button("accept","2","14","1.0-4","6",function(){ui.clear(),ui.print("submitting name to db","2","2"),NAME=profanity(o.value.toLowerCase()),!1===UID&&1<NAME.length&&null!==NAME?firebase.auth().signInAnonymously().then(()=>{UID=firebase.auth().currentUser.uid,c.submitName(UID,e,t),c.STATE=()=>{}}).catch(e=>{e.code,e.message}):!1!==UID&&1<NAME.length&&null!==NAME?c.submitName(UID,e,t):(ui.clear(),ui.print("invalid name","2","2"),window.setTimeout(c.STATE,1e3))},!0)},this.submitName=function(e,t,i=!1){1<NAME.length&&NAME.length<10?firebase.database().ref("uid/"+e).set({name:NAME},e=>{e?(ui.clear(),e="PERMISSION_DENIED"===e.code?"invalid name":"network error",ui.print(e,"2","2"),window.setTimeout(function(){c.inputName(t,i)},1e3)):(ui.clear(),ui.print("name change successful","2","2"),window.setTimeout(t,1e3))}):(ui.clear(),ui.print("invalid name","2","2"),window.setTimeout(function(){c.inputName(t,i)},1e3))},this.encodeURL=function(){let i="",o=stage.name;for(let t=0;t<o.length;t++){let e=o.charAt(t);e=" "===e?"-":e,i+=e}i+="/",i+=UID,window.history.pushState("","","/");var e=window.location.href,t="./#/"+i;navigator.clipboard.writeText("https://specialstage.io/#/"+i).then(function(){ui.print("url copied to clipboard","2","2"),window.history.pushState("","",t)},function(){window.history.pushState("","",t),ui.print("url copied to address bar","2","2")}),FIREBASE&&firebase.analytics().logEvent("challenge_issued",{url:e+"#/"+i})},this.decodeURL=function(){let i=window.location.href;let o="",n=[],s=!1,r=0;for(let t=0;t<i.length;t++){let e=i.charAt(t);s?"/"===e?(CHALLENGE=!0,r++):(1===r&&(e="-"===e?" ":e,o+=e),1<r&&(n+=e)):"#"===e&&(s=!0,CUSTOM_SEED=!0,r=0)}CHALLENGE&&0<n.length?(c.custom_seed=o,stage.name=o,c.CHALLENGES={seed:o,uid:n}):CUSTOM_SEED&&(c.custom_seed=o,stage.name=o,CHALLENGE=!1),FIREBASE&&CHALLENGE&&firebase.analytics().logEvent("challenge_accepted",{url:i})},this.cSave=function(e,t){var i=new Date;i.setTime(i.getTime()+2808e7);i="expires="+i.toUTCString();document.cookie=e+"="+t+";"+i+";path=/"},this.cLoad=function(e){for(var t=e+"=",i=document.cookie.split(";"),o=0;o<i.length;o++){let e=i[o];for(;" "==e.charAt(0);)e=e.substring(1);if(0==e.indexOf(t))return e.substring(t.length,e.length)}return""},this.checksave=function(){let l=c.cLoad("SAVE");if(0!==l.length&&null!=l){let t="",i=0,o="",n="",s="",r="",a="";let c=0;for(let e=0;e<l.length;e++){var h=l.charAt(e);if("#"!==h)switch(c){case 0:t+=h;break;case 1:i=parseInt(h);break;case 2:o+=h;break;case 3:n+=l.charAt(e),s+=l.charAt(e+1),r+=l.charAt(e+2),e+=2;break;case 4:a+=h}else c++}vehicle.MODEL=parseInt(i),vehicle.PAINT=parseInt(o),vehicle.paint(),vehicle.tune.power(parseInt(n)),vehicle.tune.drag(parseInt(s)),vehicle.tune.sensitivity(parseInt(r))}else vehicle.PAINT=0,vehicle.paint();if(l=c.cLoad("SETTINGS"),0!==l.length&&null!=l){let t=0,i="",o="",n="";for(let e=0;e<l.length;e++){var s=l.charAt(e);if("#"!==s)switch(t){case 0:i+=s;break;case 1:GHOST_PRIORITY=parseInt(s);break;case 2:o=parseInt(s);break;case 3:n=parseInt(s)}else t++}GHOST_LIMIT=parseInt(i),HITBOX=0!==o,1===n&&(UAS_ENABLED=!0)}},this.credit=()=>{ui.clear(),ui.print("procedural.ca","2","1.0-6"),ui.print("ginko.ltd","2","1.0-4")},this.promo=()=>{ui.clear(),ui.print("0.0.5.3","2","2"),ui.sprite(0,88,47,8,"2","6-4p",188,32,4),ui.sprite(49,88,40,8,"2","12-4p",160,32,4),ui.sprite(1,0,255,16,"2","1.0-6",255,16),ui.print("www.specialstage.io  ","2","1.0-8")},this.fpv=()=>{ui.clear(),ui.print("https://specialstage.io - 0.0.4","2","2"),ui.print("new feature","4","0.5"),ui.print("first person view (fpv)","4","0.5 + 4",2),window.setTimeout(function(){ui.clear(),ui.print("https://specialstage.io - 0.0.4","2","2")},4e3)},this.biome=()=>{ui.clear(),ui.print("https://specialstage.io - 0.0.4","2","2"),ui.print("new feature","4","0.5"),ui.print("ice biome","4","0.5 + 4",2),window.setTimeout(function(){ui.clear(),ui.print("https://specialstage.io - 0.0.4","2","2")},4e3)},this.physics=()=>{ui.clear(),ui.print("https://specialstage.io - 0.0.4","2","2"),ui.print("update","4","0.5"),ui.print("improved vehicle physics","4","0.5 + 4",2),window.setTimeout(function(){ui.clear(),ui.print("https://specialstage.io - 0.0.4","2","2")},4e3)},this.endtag=()=>{ui.clear(),ui.print("play at","2","0.25-4"),ui.print("https://specialstage.io","2","0.25",1),ui.print("challenges posted on discord","4","0.25+ 6"),ui.print("> discord.ginko.ltd","4","0.25 + 10"),ui.print("> discord.specialstage.io","4","0.25 + 12"),window.setTimeout(c.music,2e3)},this.music=e=>{window.setTimeout(function(){ui.print("procedural.ca","2","1.0-12")},500),window.setTimeout(function(){ui.print("ginko.ltd","2","1.0-10")},1e3),window.setTimeout(function(){},3e3)},this.updates=()=>{ui.clear(),ui.print("https://specialstage.io - 0.0.4","2","2"),ui.print("updates","2","6"),ui.print("> added ice biome","2","10"),ui.print("> added fpv camera","2","12"),ui.print("> added snow particle effects","2","14"),ui.print("> added terrain drag penalty","2","16"),ui.print("> improved vehicle physics","2","18"),ui.print("> increased gravity","2","20"),ui.print("> decreased air resistance","2","22"),ui.print("> disabled DNF timeout during button input for big jumps","2","24"),ui.print("> removed framerate dependecies","2","26"),ui.print("> reworked ui pixel scaling","2","28"),window.setTimeout(function(){ui.clear()},1e4)},this.plug=e=>{if("n"===e.key)switch(o){case 0:ui.clear(),window.setTimeout(c.promo,1e3),o++;break;case 1:window.setTimeout(c.biome,1e3),o++,vehicle.CAMERA=4;break;case 2:window.setTimeout(c.physics,1e3),o++,vehicle.CAMERA=2;break;case 3:window.setTimeout(c.fpv,1e3),o++,vehicle.CAMERA=3;break;case 4:window.setTimeout(c.endtag,1e3),o++,vehicle.CAMERA=1;break;case 5:ui.clear(),o=0}}}const TIME={dt:1,start:window.performance.now(),time:0,last:0,timestep:0,reset:function(){TIME.start=window.performance.now(),TIME.time=0,TIME.last=0,TIME.timestep=1e3/60,TIME.dt=1}},DT=()=>(TIME.time=window.performance.now()-TIME.start,TIME.timestep=TIME.time-TIME.last,TIME.dt=TIME.timestep/(1e3/60),2<TIME.dt&&(TIME.dt=2),TIME.last=TIME.time,TIME.dt);function UI(){var m=this;this.renderer=document.createElement("canvas"),this.renderer.id="ui",document.body.appendChild(this.renderer);const T=this.renderer.getContext("2d");this.context=T;const i=document.createElement("img");i.src="./img/stage.font.0.0.6.png",i.onload=function(){m.connect(),m.onload()};document.createElement("canvas");this.onload=function(){};const d=document.createElement("canvas"),o=d.getContext("2d");this.scale=1,this.col=8,this.row=8,this.width,this.height;var s={unit:8,width:128,height:128,cols:16,rows:16,offset:{x:0,y:0}};this.style=0;let r={d:{x:128,y:180,w:128,h:80}};r.a={x:128,y:r.d.y,w:128,h:80};let g=!(r.b={x:128,y:r.d.y+60,w:128,h:40}),y=[],v=[],f=[];this.connect=function(){T.imageSmoothingEnabled=!1,m.format(0,"#ffffff")},this.format=function(e=0,t="#ffffff"){void 0===d[e]&&(d[e]=document.createElement("canvas"),o[e]=d[e].getContext("2d")),o[e].drawImage(i,s.offset.x,s.offset.y,s.width,s.height,0,0,s.width,s.height),o[e].globalCompositeOperation="source-atop",o[e].fillStyle=t,o[e].fillRect(0,0,s.width,s.height),o[e].globalCompositeOperation="source-out"},this.resize=function(e,t,i,o=1){m.scale=i*o;var n=window.devicePixelRatio,s=Math.ceil(n)/n*e<300?Math.floor(n):Math.ceil(n);s-n!=0&&(i=s/n*o),n<=1&&1<m.scale&&(i=m.scale),this.width=e/i,this.height=t/i,this.renderer.width=this.width,this.renderer.height=this.height,renderer.setSize(this.width,this.height),m.scale=i,this.renderer.style.transform="scale("+i+","+i+")",renderer.domElement.style.transform="scale("+i+","+i+")",this.renderer.style.transformOrigin="top left",renderer.domElement.style.transformOrigin="top left",T.imageSmoothingEnabled=!1,this.redraw(),r.d={x:128,y:180,w:128,h:80},r.a={x:128,y:r.d.y,w:128,h:80},r.b={x:128,y:r.d.y+60,w:128,h:40},this.automate(this.width,this.height)},this.update=function(e){let t=0;for(var i in e)for(var o in f)if(e[i].x>f[o].x*m.scale&&e[i].y>f[o].y*m.scale&&e[i].x<f[o].w*m.scale&&e[i].y<f[o].h*m.scale&&(t++,1==e[i].start)){f[o].funct(),e[i].start=!1;break}},this.print=function(e,t,i,o=1){let n=0;for(var s=m.compile(t,m.width,m.col),r=m.compile(i,m.height,m.row),a=m.style;n<e.length;)m.encode(e.charAt(n),s+n*m.col*o,r,o),n++;g||y.push(function(){m.style=a,m.print(e,t,i,o)})},this.text=function(e,t,i,o=1,n){let s=0;for(;s<e.length;)m.encode(e.charAt(s),t+s*m.col*o,i,o),s++},this.button=function(e,t,i,o,n,s,r=!0,a=1){var c=m.compile(t,m.width,m.col),l=m.compile(i,m.height,m.row),h=m.compile(o,m.width,m.col),u=m.compile(n,m.height,m.row),p=m.style;r&&(T.drawImage(d[m.style],0,0,1,1,c,l+u/2,h+1,1),T.drawImage(d[m.style],0,0,1,1,c,l-u/2,h+1,1),T.drawImage(d[m.style],0,0,1,1,c,l-u/2,1,u),T.drawImage(d[m.style],0,0,1,1,c+h-1,l-u/2,1,u+1));let E=0;for(;E<e.length;)m.encode(e.charAt(E),c+E*m.col+h/2-Math.round(e.length*m.col)/2+2,l-m.row/2,a),E++;f.push({x:c,y:l-u/2,w:c+h,h:l+u/2,funct:function(){s()}}),g||y.push(function(){m.style=p,m.button(e,t,i,o,n,s,r,a)})},this.line=function(e,t,i,o){m.sprite(0,0,1,1,e,t,i,o)},this.sprite=function(e,t,i,o,n,s,r,a){var c=m.compile(n,m.width,m.col),l=m.compile(s,m.height,m.row),h=m.compile(r,m.width,m.col),u=m.compile(a,m.height,m.row),p=m.style;T.drawImage(d[m.style],e,t,i,o,c,l,h,u),g||y.push(function(){m.style=p,m.sprite(e,t,i,o,n,s,r,a)})},this.backdrop=function(e="#10101099",t,i,o=m.width,n=m.height){!1===e?(m.clear(),m.renderer.style.background="transparent"):(m.clear(),m.renderer.style.background=e)},this.getDrawList=function(){return y},this.redraw=function(){g=!0,m.clear();for(let e=0;e<y.length;e++)y[e]();var t=document.body.getElementsByTagName("input");for(let e=0;e<t.length;e++)m.text(t[e].value,t[e].style.top,t[e].style.left);g=!1},this.automate=function(e,t){e=Math.floor(e/3)-2,t=Math.floor(t/4);r.d.w>e&&(r.d.w=e,r.d.x=e,r.a.w=e,r.a.x=e,r.b.w=e,r.b.x=e),r.d.y>t&&(r.d.y=t+40,r.a.y=r.d.y,r.b.y=r.d.y+60)},this.pad=function(e,t,i,o,n,s,r){let a=0;for(r();a<control.touches.length;)control.touches[a].x>t*m.scale&&control.touches[a].y>i*m.scale&&control.touches[a].x<(t+o)*m.scale&&control.touches[a].y<(i+n)*m.scale&&s(),a++;HITBOX&&(T.drawImage(d[m.style],0,0,1,1,t+1,i,o-1,1),T.drawImage(d[m.style],0,0,1,1,t+1,i+n,o-1,1),T.drawImage(d[m.style],0,0,1,1,t+1,i,1,n),T.drawImage(d[m.style],0,0,1,1,t+o-1,i,1,n)),m.encode(e,t+o/2-m.col/2,i+n/2-m.row/2)},this.dpad=function(){T.drawImage(d[m.style],88,88,40,40,m.width-r.a.x+r.a.w/2-20,m.height-r.a.y+r.a.h/2-20,40,40),m.pad("<",r.d.x-r.d.w-1,m.height-r.d.y,r.d.w,r.d.h,function(){control.LEFT=!0},function(){control.LEFT=!1}),m.pad(">",r.d.x+1,m.height-r.d.y,r.d.w,r.d.h,function(){control.RIGHT=!0},function(){control.RIGHT=!1}),m.pad("^",m.width-r.a.x,m.height-r.a.y,r.a.w,r.a.h,function(){control.UP=!0},function(){control.UP=!1}),m.pad("b",m.width-r.b.x,m.height-r.b.y+r.b.h/2,r.b.w,r.b.h,function(){control.DOWN=!0},function(){control.DOWN=!1})},this.clear=function(){if(!g){var t=document.body.getElementsByTagName("input");for(let e=0;e<t.length;e++)document.body.removeChild(t[e]);if(!m.REDRAW){y=[];for(let e=0;e<v.length;e++)document.body.removeChild(v[e]);v=[]}y=[]}f=[],T.clearRect(0,0,m.width,m.height)},this.delete=function(e=0,t=0,i=renderer.width,o=renderer.height){e=m.compile(e,m.width,m.col),t=m.compile(t,m.height,m.row),i=m.compile(i,m.width,m.col),o=m.compile(o,m.height,m.row);T.clearRect(e,t,i,o)},this.encode=function(e,t,i,o=1){var n=e.charCodeAt(0),e=n*s.unit%s.width,n=Math.floor(n/s.cols)*s.unit;T.clearRect(t,i,s.unit,s.unit),T.drawImage(d[m.style],e,n,s.unit,s.unit,t,i,s.unit*o,s.unit*o)},this.float=function(e,t){let i=Math.floor(Math.abs(100*e));i=i.toString();let o=i.slice(0,i.length-2),n=i.slice(i.length-2,i.length);return 0==e?"0.00":(0==o.length&&(o="0"),n.length<2&&(n+="0"),t&&0<e?o="+"+o:e<0&&(o="-"+o),i=o+"."+n,i)},this.compile=function(n,s,r){let a=0;switch(s=Math.floor(s),typeof n){case"number":a=n;break;case"function":a=n();break;case"string":let e=!1,t=1,i=0,o="";for(;i<n.length;){var c=n.charAt(i);"."===c?(o+=c,e=!0):"+"===c?(o=e?Number(o)*s:Number(o)*r,o*=t,t=1,a+=o,e=!1,o=""):"-"===c?(o=e?Number(o)*s:Number(o)*r,o*=t,t=-1,a+=o,e=!1,o=""):"p"===c?(o=Number(o),o*=t,a+=o,o=""):i===n.length-1?(o+=c,o=e?Number(o)*s:Number(o)*r,o*=t,a+=o,o=""):o+=c,i++}}return a},this.textinput=function(e,t,i,o,n,s,r){var a=m.compile(t,m.width,m.col),c=m.compile(i,m.height,m.row),l=m.compile(o,m.width,m.col),h=m.compile(n,m.height,m.row),u=m.style;if(g)m.text("> "+r.value,a,c+h/2);else{(r=document.createElement("input")).type="text",r.id=s,r.name=s,r.value=e,r.style.position="fixed",r.style.top=c+"px",r.style.left=a+"px",r.style.width=l+"px",r.style.height=h+"px",r.style.paddingLeft="12px",r.style.fontSize="14px",r.style.zIndex=9999,r.style.opacity=0,r.maxlength=10,m.text("> "+r.value,a,c+h/2),document.body.appendChild(r),window.setTimeout(function(){r.focus(),r.select()},200),r.oninput=function(){p()},r.onfocusout=function(){p()},r.onfocusin=function(){p()},r.onclick=function(){p()};const p=e=>{m.delete(a,c,l,h),m.text("> "+r.value,a,c+h/2),m.text("_",r.selectionStart*m.col+2*m.col+a,c+h/2)};y.push(function(){m.style=u,m.textinput(r.value,t,i,o,n,s,r)})}},this.link=function(e,t,i,o,n,s,r,a){var c=s,l=m.compile(t,m.width,m.col)*m.scale,h=m.compile(i,m.height,m.row)*m.scale,u=m.compile(o,m.width,m.col)*m.scale,p=m.compile(n,m.height,m.row)*m.scale,E=m.style;g||y.push(function(){return new function(){m.style=E,T.style.left=l+"px",T.style.top=h+"px",T.style.width=u+"px",T.style.height=p+"px",m.print(e,l,h)}});let T=document.createElement("a");T.href=s,T.style.left=l+"px",T.style.top=h+"px",T.style.width=u+"px",T.style.height=p+"px",T.style.display="block",T.style.zIndex=400,T.style.position="fixed",T.target="_blank",T.id=c,document.body.appendChild(T),v.push(T),g=!0,m.print(e,l,h),g=!1},this.time=function(e){return(e/100).toFixed(2)},this.typewrite=function(t){m.clear();for(let e=0;e<t.length;e++){var i=(e,0),i=Math.floor(e%32),o=Math.floor(e/32);i=32+i%32*8,o=32+16*o,window.setTimeout(()=>{ui.text(t.charAt(e),i,o)},50*e)}}}function Vehicle(){const r=this;this.SPEED="",this.TEXTTIME="",this.START=!1,this.END=!1,this.RESET=!1,this.OBJECTIVE=0,this.POSITION,this.MODEL=1,this.ANALOG=!1,this.PENALTY=function(){return t},this.CAMERA=1,this.FPV=!1,this.inputs=[],this.PHYSICSBUFFER=[],this.RAW=[],this.DISTANCE_AUDIT=[],this.SYNC=!1,this.START_POSITION=new THREE.Vector3,this.START_NORMAL=new THREE.Vector3,this.START_DIRECTION=new THREE.Vector3,this.START_VELOCITY=new THREE.Vector3,this.START_ROTATION=0,this.START_MESH=new THREE.Mesh,this.FRAME_TIME=0,this.BATCH_POSITIONS=[],this.IMPORT=!1,this.DISCONNECT=!1,this.SAVE_PARAM={model:0,paint:0,power:0,drag:0,sensitivity:0},this.DEBUG_BUFFER=[],this.IMPORT_BUFFER=[],this.FRAME=0;let a=[],c=0;this.TIMESTEP=TIMESTEP;this.TIMESTAMP=0,this.REPLAY=!1,this.REPLAY_START=!1,this.INPUTS=[];const l=new THREE.Mesh(new THREE.IcosahedronGeometry(4,0),new THREE.MeshBasicMaterial({wireframe:!0}));let h=!1,u=!1,p=!1,E=!1;let T=!0,m=!1;this.CHECKPOINT=[],this.VALIDATE_CHECKPOINT=[],this.best=[];let d=0,g=0,t=0;let y=1e3,v=0,f=!1,A=!1,i=0;let w=0;this.DT=()=>1;const o={power:3,drag:1,mass:1,brake:3,sensitivity:2,ease:0},n={power:{lo:.016,hi:.02,range:0},drag:{lo:.98,hi:.985,range:0},brake:{lo:.98,hi:.95,range:0},sensitivity:{lo:.06,hi:.08,range:0},ease:{lo:6,hi:12,range:0}};n.power.range=n.power.hi-n.power.lo,n.drag.range=n.drag.hi-n.drag.lo,n.brake.range=n.brake.hi-n.brake.lo,n.sensitivity.range=n.sensitivity.hi-n.sensitivity.lo,n.ease.range=n.ease.hi-n.ease.lo;let R,I,S,M=6,N=.95,O,H=0,s=0,L=0;const b=new THREE.Vector3(0,1,0),P=new THREE.Vector3(0,0,0),C=new THREE.Vector3,_=new THREE.Vector3(0,5,0);new THREE.Vector3(1,0,0);const D=new THREE.Vector3(0,0,1),B=new THREE.Vector3(0,0,1),G=new THREE.Vector3(0,0,1),x=new THREE.Vector3(0,0,1),U=new THREE.Vector3(0,0,-.008),V=.998;const k=new THREE.Vector3,F=new THREE.Vector3,Y=new THREE.Vector3,K=new THREE.Vector3;this.position=k.clone(),this.direction=b.clone(),this.lookAt=k.clone(),this.normal=B.clone(),this.rotation=0;let z=[];const W=new THREE.Vector3(0,0,1),X=new THREE.Raycaster(K,W,0,2);this.cameras=[],this.cameras[0]={distance:22,x:0,y:0,z:9,lerp:.1,lookAt:new THREE.Vector3},this.cameras[1]={distance:0,x:20,y:20,z:10,lerp:.05,lookAt:new THREE.Vector3},this.cameras[2]={distance:0,x:-20,y:-20,z:20,lerp:.05,lookAt:new THREE.Vector3},this.cameras[3]={distance:0,x:-40,y:40,z:30,lerp:.075,lookAt:new THREE.Vector3},this.cameras[4]={distance:0,x:0,y:-20,z:60,lerp:.0075,lookAt:new THREE.Vector3};const j=[];j[0]={name:"logistics crate",geometry:()=>MODEL.logistics_crate()},j[1]={name:"ag-86",geometry:()=>MODEL.ag_86()},this.models=function(){return j},this.PAINT=0;const q=new THREE.MeshBasicMaterial({color:PAINT[r.PAINT]}),e=new THREE.LineSegments(j[r.MODEL].geometry(),q),Z=e.clone();Z.name="Vehicle";const J=new MODEL.emitter;this.connect=function(e,t){Z.copy(new THREE.LineSegments(j[r.MODEL].geometry(),q)),Z.name="Vehicle",Z.geometry.computeBoundingSphere(),Y.copy(e),Y.z+=2,Z.position.copy(Y),scene.add(Z),J.connect(PAINT[r.PAINT]),r.tune.power(),r.tune.drag(),r.tune.sensitivity(),r.tune.ease(),scene.fog=new THREE.FogExp2(palette[0],.005),camera.fov=90,camera.updateProjectionMatrix(),scene.add(stage.generate.stars),r.START_POSITION.copy(Y),r.START_NORMAL.copy(B),r.START_DIRECTION.copy(b),r.START_VELOCITY.copy(C),r.START_MESH.copy(l),uas.TARGETS.length<ghost.length+1&&uas.TARGETS.push(this),this.CHECKPOINT=[],this.RESET=!0,this.reset()},this.disconnect=function(){this.DISCONNECT=!0,this.IMPORT=!1,this.RESET=!1,r.reset(!1),scene.remove(Z),J.disconnect(),scene.fog=new THREE.FogExp2(palette[0],0),scene.remove(stage.generate.stars),this.DISCONNECT=!1},this.ready=function(e=window.performance.now()){var t;!h&&!this.REPLAY||this.RESET||(stage.generate.checkpoints[0].display.material.color=palette[4],uas.reset(),w=1,f=!1,A=!1,T=!0,TIME.reset(),v=e,d=0,c=0,this.FRAME=0,a[c].time=0,a=[],a.length=0,c=0,a.push({time:0,position:r.START_POSITION.clone(),normal:r.START_NORMAL.clone(),direction:r.START_DIRECTION.clone(),velocity:r.START_VELOCITY.clone(),rotation:0,step:0,U:!1,D:!1,L:!1,R:!1}),r.REPLAY?(r.DEBUG_BUFFER=[],t={time:0,position:r.START_POSITION.clone(),direction:r.START_DIRECTION.clone(),normal:r.START_NORMAL.clone(),velocity:r.START_VELOCITY.clone(),rotation:0,U:!1,D:!1,L:!1,R:!1,step:0},r.DEBUG_BUFFER.push(t),r.DISTANCE_AUDIT=[]):(r.INPUTS=[],r.PHYSICSBUFFER=[],r.PHYSICSBUFFER.length=0,t={},Object.assign(t,a[c]),r.PHYSICSBUFFER.push(t),r.CHECKPOINT[0]=Date.now()),r.START=!0)},this.reset=function(e=!1){r.REPLAY=e,r.RESET=!0,PLAY=!e,this.SYNC=!1,this.TIMESTAMP=0,this.FRAME=0,this.START=!1,this.END=!1,DNF=!1,m=!1,control.UP=!1,control.DOWN=!1,control.LEFT=!1,control.RIGHT=!1,h=!1,u=!1,p=!1,E=!1,i=0,t=0,w=0,k.copy(r.START_POSITION),F.copy(k),b.copy(r.START_DIRECTION),C.copy(r.START_VELOCITY),B.copy(r.START_NORMAL),K.copy(k),this.position=k.clone(),this.direction=b.clone(),this.lookAt=k.clone(),this.normal=B.clone(),this.rotation=0,s=0,H=0,L=0,O=0,r.SPEED=0,W.copy(r.START_NORMAL),W.normalize(),X.far=W.length(),X.set(r.START_POSITION,W),G.copy(r.START_NORMAL),x.copy(r.START_NORMAL),x.add(r.START_POSITION),camera.updateProjectionMatrix(),m=!0,J.reset(),TIME.reset(),uas.reset(),a=[],c=0,v=0,this.IMPORT||(v=window.performance.now());for(let e=0;e<stage.generate.checkpoints.length;e++)stage.generate.checkpoints[e].display.material.color=palette[5];if(a[0]={time:0,position:this.START_POSITION.clone(),normal:this.START_NORMAL.clone(),direction:this.START_DIRECTION.clone(),velocity:this.START_VELOCITY.clone(),rotation:0,step:0,U:!1,D:!1,L:!1,R:!1},!r.REPLAY){this.DEBUG_BUFFER=[],d=0,r.best=r.overwrite(r.CHECKPOINT,r.best),stage.best=r.overwrite(r.CHECKPOINT,stage.best),this.CHECKPOINT=[],this.CHECKPOINT.length=6,r.inputs=[],r.inputs.push({key:0,time:0});for(let e=0;e<ghost.length;e++)ghost[e].reset();r.PHYSICSBUFFER=[];e={};Object.assign(e,a[c]),r.PHYSICSBUFFER.push(e)}this.VALIDATE_CHECKPOINT=[],this.VALIDATE_CHECKPOINT.length=6,l.position.copy(r.START_POSITION),l.lookAt(x),Z.lookAt(x),l.rotateOnAxis(D,0),l.updateMatrix(),Z.updateMatrix(),f=!1,A=!1,T=!0,this.DISTANCE_AUDIT=[],r.RESET=!1},this.update=function(e=window.performance.now()){DNF||r.END||!m||r.REPLAY||r.RESET?(h=!1,u=!1,p=!1,E=!1):(h=control.UP,u=control.DOWN,p=control.LEFT,E=control.RIGHT,p&&E&&(p=!1,E=!1)),this.START||this.ready(),this.TIMESTAMP=this.IMPORT?e+99999-v:e-v;let i=0;if(this.TIMESTAMP>a[c].time){let e={};Object.assign(e,a[c]);let t=e.time;for(a=[],c=0,a.push({time:t,position:e.position.clone(),normal:e.normal.clone(),direction:e.direction.clone(),velocity:e.velocity.clone(),rotation:e.rotation,step:e.step,U:e.U,D:e.D,L:e.L,R:e.R});t<this.TIMESTAMP;){var o;t+=TIMESTEP,this.REPLAY&&this.START&&(i=this.tapeReplay(t)),a.push({time:t,position:a[c].position.clone(),normal:a[c].normal.clone(),direction:a[c].direction.clone(),velocity:a[c].velocity.clone(),rotation:a[c].rotation,step:a[c].step,U:h,D:u,L:p,R:E}),c=a.length-1,r.START&&(s=n=void 0,s=p&&E?0:p?1:E?-1:0,L=a[c].step,0!=s&&Math.abs(L)<M?L+=s:Math.abs(L)>M?(n=L/Math.abs(L),L=M*n):0<Math.abs(L)&&(n=L/Math.abs(L),L-=L/Math.abs(L),L/Math.abs(L)!=n&&(L=0)),H=L/M*S,a[c].rotation+=H,a[c].step=L,O=a[c].velocity.length(),n=void 0,h&&T&&(P.copy(a[c].direction),P.multiplyScalar(R),a[c].velocity.add(P)),u&&T&&a[c].velocity.multiplyScalar(N),T?(A=!1,n=f?I-.01:I,a[c].velocity.multiplyScalar(n)):T||(A?a[c].velocity.add(U):A=!0,a[c].velocity.multiplyScalar(V)),a[c].position.add(a[c].velocity),l.position.copy(a[c].position),function(){z=[],K.copy(a[c].position),K.z-=50,W.set(0,0,1),X.far=100,X.set(K,W),stage.surface.raycast(X,z),0<z.length?(K.copy(z[0].point),f=a[c].position.z<K.z&&Math.abs(a[c].position.z-K.z)<5?(g=0,T=!0,B.copy(z[0].face.normal),a[c].position.copy(K),1!==z[0].face.color.r):T=!1):0===z.length&&(T=!1,f=!1,h||u||p||E||r.REPLAY||(g+=TIMESTEP),g>y&&!r.END&&!DNF&&(DNF=!0,state.dnf()));var e=A?.001:.25;G.copy(a[c].normal),G.lerp(B,e);let t=G.clone();t.add(a[c].position),a[c].normal=G.clone(),l.lookAt(t),l.rotateOnAxis(D,a[c].rotation),b.copy(l.localToWorld(_.clone())),b.sub(a[c].position),b.normalize(),a[c].direction.copy(b)}(),function(){z=[],W.copy(a[c].position),W.sub(a[c-1].position),W.normalize(),X.far=W.length(),X.set(a[c].position,W);let i=0,t=!1;for(let e=w;e<5;e++)if(stage.generate.checkpoints[e].collision.raycast(X,z),0<z.length){i=e,t=!0;break}if(t){let e=a[c-1].position,t=a[c].position;var o=z[0].point,n=e.distanceTo(o),o=t.distanceTo(o),o=n/(n+o),o=a[c-1].time+r.TIMESTEP*o;stage.generate.checkpoints[i].display.material.color=palette[4],r.CHECKPOINT[i]=Math.floor(o/10);o=w!==i;r.CHECKPOINT[5]=0;for(let e=1;e<i;e++)void 0===r.CHECKPOINT[e]&&--r.CHECKPOINT[5];w=i+1,4<=i&&!r.REPLAY?(r.END=!0,r.REPLAY||state.complete()):r.REPLAY||r.IMPORT||state.checkpoint(o)}r.SPEED=Math.round(60*O/1e3*3600),r.START&&!r.END&&(d=Math.floor(a[c].time/10)),r.OBJECTIVE=w,F.copy(k)}()),l.updateMatrix(),this.FRAME++,this.START&&!this.REPLAY?(o={},Object.assign(o,a[c]),this.PHYSICSBUFFER.push(o)):this.REPLAY&&i<this.PHYSICSBUFFER.length-1&&!this.RESET||this.REPLAY&&(o={time:a[c].time,position:a[c].position.clone(),direction:a[c].direction.clone(),normal:a[c].normal.clone(),velocity:a[c].velocity.clone(),rotation:a[c].rotation,U:a[c].U,D:a[c].D,L:a[c].L,R:a[c].R,step:a[c].step},r.DEBUG_BUFFER.push(o))}}var n,s;this.position.copy(a[c].position),this.direction.copy(a[c].direction),this.rotation=a[c].rotation,this.lookAt.copy(a[c].position),this.normal.copy(a[c].normal);let t=this.normal.clone();t.add(this.position),Z.position.copy(this.position),Z.lookAt(t),Z.rotateOnAxis(D,this.rotation),J.update(h,this.position,this.direction,O),r.REPLAY_START&&r.replay(),this.DISCONNECT?r.disconnect():r.RESET&&r.reset(r.REPLAY)},this.results=function(){return{reward:i,yen:0}},this.AT=function(){return d},this.convert=function(i){const o=[];for(let t=0;t<i.length;t++){var n=i[t].U,s=i[t].D,r=i[t].L,a=i[t].R,c=n&&s&&r,l=n&&s&&a;let e=0;c||l?c?e="a":l&&(e="b"):(e+=n?3:s?6:0,e+=r?1:a?2:0),o.push(e.toString())}return o},this.replay=function(e){r.REPLAY_START?(0===r.INPUTS.length&&(r.INPUTS=r.PHYSICSBUFFER.slice()),PLAY=!1,r.REPLAY=!0,r.REPLAY_START=!1,r.RESET=!0):r.REPLAY_START=!0},this.desyncTune=function(e=!0,t){e?(r.SAVE_PARAM.power=t.power,r.SAVE_PARAM.drag=t.drag,r.SAVE_PARAM.sensitivity=t.sensitivity,r.SAVE_PARAM.model=t.model,r.SAVE_PARAM.paint=t.paint):(r.PAINT=r.SAVE_PARAM.paint,r.MODEL=r.SAVE_PARAM.model,r.paint(),r.body(),r.tune.power(r.SAVE_PARAM.power),r.tune.drag(r.SAVE_PARAM.drag),r.tune.sensitivity(r.SAVE_PARAM.sensitivity))},this.import=function(){var e=ghost.length+" / "+state.BATTLE.length;0===ghost.length&&(r.SAVE_PARAM.power=r.param().power,r.SAVE_PARAM.drag=r.param().drag,r.SAVE_PARAM.sensitivity=r.param().sensitivity,r.SAVE_PARAM.model=r.MODEL,r.SAVE_PARAM.paint=r.PAINT),ghost.length<state.BATTLE.length?(state.scan(e,!1),this.reset(),r.PAINT=state.BATTLE[ghost.length].param.paint,r.MODEL=state.BATTLE[ghost.length].param.model,r.paint(),r.body(),r.tune.power(state.BATTLE[ghost.length].param.power),r.tune.drag(state.BATTLE[ghost.length].param.drag),r.tune.sensitivity(state.BATTLE[ghost.length].param.sensitivity),r.INPUTS=state.BATTLE[ghost.length].data,r.IMPORT_BUFFER=state.BATTLE[ghost.length].IMPORT_BUFFER,this.IMPORT=!0,this.REPLAY_START=!0,this.RESET=!0,this.reset(),r.replay()):(a[c].time=0,this.IMPORT=!1,SPECTATE?(this.RESET=!0,this.reset(),this.REPLAY_START=!0,r.replay(),uas.spectate(),state.replay("import"),this.INPUTS=[]):(this.reset(!1),state.play()),r.PAINT=r.SAVE_PARAM.paint,r.MODEL=r.SAVE_PARAM.model,r.paint(),r.body(),r.tune.power(r.SAVE_PARAM.power),r.tune.drag(r.SAVE_PARAM.drag),r.tune.sensitivity(r.SAVE_PARAM.sensitivity))};function $(e){return e=e<0?0:5<e?5:e}this.tune={power:function(e=o.power){o.power=$(e),R=n.power.lo+o.power/5*n.power.range},drag:function(e=o.drag){o.drag=$(e),I=n.drag.hi-o.drag/5*n.drag.range},sensitivity:function(e=o.sensitivity){o.sensitivity=$(e),S=n.sensitivity.lo+o.sensitivity/5*n.sensitivity.range},ease:function(e=o.ease){o.ease=$(e),M=n.ease.lo+o.ease}},this.param=function(){return array=Object.assign(o,[]),array.model=r.MODEL,array.paint=r.PAINT,array},this.paint=function(e=r.PAINT){r.PAINT=e,J.paint(PAINT[e]),q.color.set(PAINT[e]),q.needsUpdate=!0},this.body=function(){Z.geometry.dispose(),Z.geometry=j[r.MODEL].geometry().clone(),Z.geometry.verticesNeedUpdate=!0},this.yen=function(){return state.cSave("YEN",0),0},this.debug=function(){console.log("position:",k),console.log("direction:",b),console.log("rotation:",s),console.log("dt:",1),console.log("TIME:",RAFID),console.log("INTERPOLATION:",1),console.log("PHYSICS MESH:",l.rotation),console.log("EASE",M),console.log(a),console.log(g),console.log("TIMESTAMPS",this.TIMESTAMP),console.log("KEYBUFFER",this.inputs[this.inputs.length-1]),console.log("PHYSICS",a[c]),console.log("PHYSICSBUFFER",this.PHYSICSBUFFER)},this.tapeReplay=function(e){let t=0;if(0==r.INPUTS.length)t=0;else if(e<r.INPUTS[r.INPUTS.length-1].time){for(;r.INPUTS[t].time<e;)t++;h=this.INPUTS[t].U,u=this.INPUTS[t].D,p=this.INPUTS[t].L,E=this.INPUTS[t].R}else if(this.IMPORT){let t=!0,i="";for(let e=1;e<this.CHECKPOINT.length;e++)this.CHECKPOINT[e]!==state.BATTLE[ghost.length].cp[e]&&(""===i&&(i+="checkpoint_discrepancy"),t=!1);r.CHECKPOINT[4]-1e4*r.CHECKPOINT[5]!==state.BATTLE[ghost.length].time&&(t=!1,i+="final_time_discrepancy"),t?ghost.push(new Ghost(this.DEBUG_BUFFER.slice(),this.MODEL,this.PAINT,this.CHECKPOINT.slice())):(FIREBASE&&firebase.analytics().logEvent("invalid_data",{seed:stage.name,uid:state.BATTLE[ghost.length].uid,name:state.BATTLE[ghost.length].name,report:stage.name+"/"+state.BATTLE[ghost.length].uid+"("+state.BATTLE[ghost.length].name+")"+i+" : "+UID+"/("+NAME+")",error:i}),state.BATTLE.splice(ghost.length,1)),this.import()}else r.replay(!1),this.IMPORT=!1,this.START=!1;return t},this.overwrite=function(e,t,i=!0){var o=0===t.length,n=e[4]+1e3*e[5]<t[4]*t[5]*1e3,s=e[5]>t[5],r=void 0!==e[4];return(o||n||s)&&r?!i||e:!!i&&t},this.decode=function(e){const t=[];t[0]=()=>{control.UP=!1,control.DOWN=!1,control.LEFT=!1,control.RIGHT=!1},t[1]=()=>{control.UP=!1,control.DOWN=!1,control.LEFT=!0,control.RIGHT=!1},t[2]=()=>{control.UP=!1,control.DOWN=!1,control.LEFT=!1,control.RIGHT=!0},t[3]=()=>{control.UP=!0,control.DOWN=!1,control.LEFT=!1,control.RIGHT=!1},t[4]=()=>{control.UP=!0,control.DOWN=!1,control.LEFT=!0,control.RIGHT=!1},t[5]=()=>{control.UP=!0,control.DOWN=!1,control.LEFT=!1,control.RIGHT=!0},t[6]=()=>{control.UP=!1,control.DOWN=!0,control.LEFT=!1,control.RIGHT=!1},t[7]=()=>{control.UP=!1,control.DOWN=!0,control.LEFT=!0,control.RIGHT=!1},t[8]=()=>{control.UP=!1,control.DOWN=!0,control.LEFT=!1,control.RIGHT=!0},t[9]=()=>{control.UP=!0,control.DOWN=!0,control.LEFT=!1,control.RIGHT=!1},t.a=()=>{control.UP=!0,control.DOWN=!0,control.LEFT=!0,control.RIGHT=!1},t.b=()=>{control.UP=!0,control.DOWN=!0,control.LEFT=!1,control.RIGHT=!0},t[e]()},this.audit=function(){}}function VHS(e){var l=this;this.PLAY=!1,this.RECORD=!0,this.tape=[],this.frame=0,this.timer=0,this.AT=function(){return l.tape[t].timer},this.DT=DT();let t=0;this.keybuffer=[],this.SCAN=!1,this.inputCapture=function(e){var t=(control.UP?3:control.DOWN?6:0)+(control.LEFT?1:control.RIGHT?2:0);this.keybuffer.push({key:t,time:e})},this.simulate=function(){},this.capture=function(e){return{position:(new THREE.Vector3).copy(e.position),normal:(new THREE.Vector3).copy(e.normal),lookTarget:e.lookTarget.clone(),rotation:e.rotation,timer:e.getTime(),objective:e.getObjective(),check:e.check,UP:e.UP}},this.record=function(e){l.tape[t]=e.record(),t=24e4<l.tape[t].TS?0:t+1},this.play=function(e){if(this.RECORD){this.RECORD=!1;for(let e=l.frame=0;e<ghost.length;e++)ghost[e].reset();TIME.reset(),TIMEOUT=0}if(l.frame>l.tape.length-10){l.frame=0,TIME.reset();for(let e=0;e<ghost.length;e++)ghost[e].reset();stage.generate.resetCheckpoints()}if(e.replay(),this.tape[l.frame].check){let e=0;e=0===this.tape[l.frame].objective?4:this.tape[l.frame].objective-1,stage.generate.checkpoints[e].display.material.color=palette[4]}},this.reset=function(){stage.generate.resetCheckpoints(),t=0,l.frame=0,TIME.reset(),l.PLAY=!1,l.RECORD=!0,l.tape=[]},this.export=function(t=function(){state.results()},e){var i=vehicle.CHECKPOINT[4]-1e4*vehicle.CHECKPOINT[5];if((i<PERSONAL_BEST||!1===PERSONAL_BEST)&&""!==NAME&&null!==NAME&&!1!==UID&&void 0!==UID&&!l.SCAN){state.STATE=()=>{ui.clear(),ui.print("uploading vhs to db","2","2")},state.STATE();UID;var o=stage.name,n=vehicle.CHECKPOINT.slice(),s=vehicle.CHECKPOINT[0],r=vehicle.param();const c=[];for(;c.length<vehicle.PHYSICSBUFFER.length;){var a=c.length,a={time:vehicle.PHYSICSBUFFER[a].time,U:vehicle.PHYSICSBUFFER[a].U,D:vehicle.PHYSICSBUFFER[a].D,L:vehicle.PHYSICSBUFFER[a].L,R:vehicle.PHYSICSBUFFER[a].R};c.push(a)}r={version:DB_BUILD,id:UID,seed:o,time:i,cp:n,utc:s,debug:c,param:r},firebase.database().ref("vhs/"+DB_BUILD+"/"+r.seed+"/"+UID).set(r,e=>{e?(ui.clear(),ui.print("network error","2","2")):(ui.clear(),ui.print("vhs succesfully submitted","2","2")),window.setTimeout(t,1e3),uas.replay(),vehicle.replay()})}else void 0===UID||!1===UID||null===NAME||""===NAME||void 0===NAME?state.register():(state.results(),uas.replay(),vehicle.replay())},this.burn=function(e){return Math.round(1e9*e).toString(16)},this.read=function(e){return parseInt(e,16)/1e9},this.scan=function(e,t){l.SCAN=!0;let o=[];firebase.database().ref("vhs/"+DB_BUILD+"/"+e).orderByChild("time").limitToFirst(SCORE_LIMIT).once("value").then(function(e){e.forEach(function(e){var t=e.child("id").val(),i=e.child("time").val(),e=e.child("utc").val();o.push({uid:t,time:i,utc:e})}),l.SCAN=!1,t(o)})},this.checkTime=function(e,t,i){e===t&&(PERSONAL_BEST=i)},this.requestName=function(e,t){firebase.database().ref("uid/"+e).once("value").then(e=>{e=e.child("name").val();return t(e),e})},this.import=function(e,s=function(){}){firebase.database().ref("vhs/"+DB_BUILD+"/"+e).once("value").then(e=>{let t=e.val();var i=t.id,o=t.seed,n=t.cp.slice(),e=t.utc;t.model,t.paint,t.param;s({uid:i,seed:o,cp:n,utc:e,debug:t.debug.slice(),param:t.param})})},this.save=function(t,e=1e3/30){let i=0,o=[];var n=t[t.length-1].TS;let s=0;for(;s<n;)s+=e,s<n&&o.push({TS:s});for(let e=0;e<o.length;e++)i=l.convert(t,o[e],i);return o},this.convert=function(e,t,i){var o=e[i].time;let n=e[i+1].TS,s=n-o;for(;t.time>n&&i<e.length-2;)o=e[++i].time,n=e[i+1].time,s=n-o;var r=i,a=i+1,c=(s-(n-t.time))/s;return t.position=new THREE.Vector3,t.position.copy(e[r].position),t.position.lerp(e[a].position,c),t.lookTarget=new THREE.Vector3,t.lookTarget.copy(e[r].normal),t.lookTarget.lerp(e[a].normal,c),t.rotation=(e[a].rotation-e[r].rotation)*c,t.rotation+=e[r].rotation,t.rotation=(e[a].rotation-e[r].rotation)*c,t.rotation+=e[r].rotation,t.AT=(e[a].AT-e[r].AT)*c,t.AT+=e[r].AT,t.UP=e[r].UP,t.check=e[r].check,t.objective=e[r].objective,i}}TIME.convert=(i=[])=>{let o="[\n";for(let t=0;t<i.length;t++){o+="'";for(let e=0;e<i[t].length;e++)o+=i[t].charCodeAt(e).toString(16);o+="',\n"}return o+="]",console.log(o),o};